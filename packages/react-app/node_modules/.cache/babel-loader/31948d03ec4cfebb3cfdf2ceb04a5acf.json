{"ast":null,"code":"'use strict';\n\nvar _objectSpread = require(\"/Users/sam/Desktop/kiwik/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/objectSpread2\");\n\nvar _asyncToGenerator = require(\"/Users/sam/Desktop/kiwik/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _regeneratorRuntime = require(\"/Users/sam/Desktop/kiwik/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncIterator = require(\"/Users/sam/Desktop/kiwik/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncIterator\");\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\n\nvar debug = require('debug');\n\nvar configure = require('../lib/configure.js');\n\nvar toUrlSearchParams = require('../lib/to-url-search-params.js');\n\nvar httpRpcWireFormat = require('../lib/http-rpc-wire-format.js');\n\nfunction _interopDefaultLegacy(e) {\n  return e && typeof e === 'object' && 'default' in e ? e : {\n    'default': e\n  };\n}\n\nvar debug__default = /*#__PURE__*/_interopDefaultLegacy(debug);\n\nvar log = debug__default[\"default\"]('ipfs-http-client:pubsub:subscribe');\n\nvar createSubscribe = function createSubscribe(options, subsTracker) {\n  return configure.configure(function (api) {\n    function subscribe(_x, _x2) {\n      return _subscribe.apply(this, arguments);\n    }\n\n    function _subscribe() {\n      _subscribe = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(topic, handler) {\n        var options,\n            done,\n            fail,\n            result,\n            ffWorkaround,\n            _args2 = arguments;\n        return _regeneratorRuntime.wrap(function _callee$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                options = _args2.length > 2 && _args2[2] !== undefined ? _args2[2] : {};\n                options.signal = subsTracker.subscribe(topic, handler, options.signal);\n                result = new Promise(function (resolve, reject) {\n                  done = resolve;\n                  fail = reject;\n                });\n                ffWorkaround = setTimeout(function () {\n                  return done();\n                }, 1000);\n                api.post('pubsub/sub', {\n                  signal: options.signal,\n                  searchParams: toUrlSearchParams.toUrlSearchParams(_objectSpread({\n                    arg: httpRpcWireFormat.textToUrlSafeRpc(topic)\n                  }, options)),\n                  headers: options.headers\n                }).catch(function (err) {\n                  subsTracker.unsubscribe(topic, handler);\n                  fail(err);\n                }).then(function (response) {\n                  clearTimeout(ffWorkaround);\n\n                  if (!response) {\n                    return;\n                  }\n\n                  readMessages(response, {\n                    onMessage: handler,\n                    onEnd: function onEnd() {\n                      return subsTracker.unsubscribe(topic, handler);\n                    },\n                    onError: options.onError\n                  });\n                  done();\n                });\n                return _context2.abrupt(\"return\", result);\n\n              case 6:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee);\n      }));\n      return _subscribe.apply(this, arguments);\n    }\n\n    return subscribe;\n  })(options);\n};\n\nfunction readMessages(response, _ref) {\n  var onMessage = _ref.onMessage,\n      onEnd = _ref.onEnd,\n      onError = _ref.onError;\n\n  var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _value, msg;\n\n  return _regeneratorRuntime.async(function readMessages$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          onError = onError || log;\n          _context.prev = 1;\n          _iteratorNormalCompletion = true;\n          _didIteratorError = false;\n          _context.prev = 4;\n          _iterator = _asyncIterator(response.ndjson());\n\n        case 6:\n          _context.next = 8;\n          return _regeneratorRuntime.awrap(_iterator.next());\n\n        case 8:\n          _step = _context.sent;\n          _iteratorNormalCompletion = _step.done;\n          _context.next = 12;\n          return _regeneratorRuntime.awrap(_step.value);\n\n        case 12:\n          _value = _context.sent;\n\n          if (_iteratorNormalCompletion) {\n            _context.next = 28;\n            break;\n          }\n\n          msg = _value;\n          _context.prev = 15;\n\n          if (msg.from) {\n            _context.next = 18;\n            break;\n          }\n\n          return _context.abrupt(\"continue\", 25);\n\n        case 18:\n          onMessage({\n            from: msg.from,\n            data: httpRpcWireFormat.rpcToBytes(msg.data),\n            seqno: httpRpcWireFormat.rpcToBytes(msg.seqno),\n            topicIDs: httpRpcWireFormat.rpcArrayToTextArray(msg.topicIDs)\n          });\n          _context.next = 25;\n          break;\n\n        case 21:\n          _context.prev = 21;\n          _context.t0 = _context[\"catch\"](15);\n          _context.t0.message = \"Failed to parse pubsub message: \".concat(_context.t0.message);\n          onError(_context.t0, false, msg);\n\n        case 25:\n          _iteratorNormalCompletion = true;\n          _context.next = 6;\n          break;\n\n        case 28:\n          _context.next = 34;\n          break;\n\n        case 30:\n          _context.prev = 30;\n          _context.t1 = _context[\"catch\"](4);\n          _didIteratorError = true;\n          _iteratorError = _context.t1;\n\n        case 34:\n          _context.prev = 34;\n          _context.prev = 35;\n\n          if (!(!_iteratorNormalCompletion && _iterator.return != null)) {\n            _context.next = 39;\n            break;\n          }\n\n          _context.next = 39;\n          return _regeneratorRuntime.awrap(_iterator.return());\n\n        case 39:\n          _context.prev = 39;\n\n          if (!_didIteratorError) {\n            _context.next = 42;\n            break;\n          }\n\n          throw _iteratorError;\n\n        case 42:\n          return _context.finish(39);\n\n        case 43:\n          return _context.finish(34);\n\n        case 44:\n          _context.next = 49;\n          break;\n\n        case 46:\n          _context.prev = 46;\n          _context.t2 = _context[\"catch\"](1);\n\n          if (!isAbortError(_context.t2)) {\n            onError(_context.t2, true);\n          }\n\n        case 49:\n          _context.prev = 49;\n          onEnd();\n          return _context.finish(49);\n\n        case 52:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, null, null, [[1, 46, 49, 52], [4, 30, 34, 44], [15, 21], [35,, 39, 43]], Promise);\n}\n\nvar isAbortError = function isAbortError(error) {\n  switch (error.type) {\n    case 'aborted':\n      return true;\n\n    case 'abort':\n      return true;\n\n    default:\n      return error.name === 'AbortError';\n  }\n};\n\nexports.createSubscribe = createSubscribe;","map":{"version":3,"sources":["/Users/sam/Desktop/kiwik/node_modules/ipfs-http-client/cjs/src/pubsub/subscribe.js"],"names":["Object","defineProperty","exports","value","debug","require","configure","toUrlSearchParams","httpRpcWireFormat","_interopDefaultLegacy","e","debug__default","log","createSubscribe","options","subsTracker","api","subscribe","topic","handler","signal","result","Promise","resolve","reject","done","fail","ffWorkaround","setTimeout","post","searchParams","arg","textToUrlSafeRpc","headers","catch","err","unsubscribe","then","response","clearTimeout","readMessages","onMessage","onEnd","onError","ndjson","msg","from","data","rpcToBytes","seqno","topicIDs","rpcArrayToTextArray","message","isAbortError","error","type","name"],"mappings":"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","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\nvar debug = require('debug');\nvar configure = require('../lib/configure.js');\nvar toUrlSearchParams = require('../lib/to-url-search-params.js');\nvar httpRpcWireFormat = require('../lib/http-rpc-wire-format.js');\n\nfunction _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }\n\nvar debug__default = /*#__PURE__*/_interopDefaultLegacy(debug);\n\nconst log = debug__default[\"default\"]('ipfs-http-client:pubsub:subscribe');\nconst createSubscribe = (options, subsTracker) => {\n  return configure.configure(api => {\n    async function subscribe(topic, handler, options = {}) {\n      options.signal = subsTracker.subscribe(topic, handler, options.signal);\n      let done;\n      let fail;\n      const result = new Promise((resolve, reject) => {\n        done = resolve;\n        fail = reject;\n      });\n      const ffWorkaround = setTimeout(() => done(), 1000);\n      api.post('pubsub/sub', {\n        signal: options.signal,\n        searchParams: toUrlSearchParams.toUrlSearchParams({\n          arg: httpRpcWireFormat.textToUrlSafeRpc(topic),\n          ...options\n        }),\n        headers: options.headers\n      }).catch(err => {\n        subsTracker.unsubscribe(topic, handler);\n        fail(err);\n      }).then(response => {\n        clearTimeout(ffWorkaround);\n        if (!response) {\n          return;\n        }\n        readMessages(response, {\n          onMessage: handler,\n          onEnd: () => subsTracker.unsubscribe(topic, handler),\n          onError: options.onError\n        });\n        done();\n      });\n      return result;\n    }\n    return subscribe;\n  })(options);\n};\nasync function readMessages(response, {onMessage, onEnd, onError}) {\n  onError = onError || log;\n  try {\n    for await (const msg of response.ndjson()) {\n      try {\n        if (!msg.from) {\n          continue;\n        }\n        onMessage({\n          from: msg.from,\n          data: httpRpcWireFormat.rpcToBytes(msg.data),\n          seqno: httpRpcWireFormat.rpcToBytes(msg.seqno),\n          topicIDs: httpRpcWireFormat.rpcArrayToTextArray(msg.topicIDs)\n        });\n      } catch (err) {\n        err.message = `Failed to parse pubsub message: ${ err.message }`;\n        onError(err, false, msg);\n      }\n    }\n  } catch (err) {\n    if (!isAbortError(err)) {\n      onError(err, true);\n    }\n  } finally {\n    onEnd();\n  }\n}\nconst isAbortError = error => {\n  switch (error.type) {\n  case 'aborted':\n    return true;\n  case 'abort':\n    return true;\n  default:\n    return error.name === 'AbortError';\n  }\n};\n\nexports.createSubscribe = createSubscribe;\n"]},"metadata":{},"sourceType":"script"}