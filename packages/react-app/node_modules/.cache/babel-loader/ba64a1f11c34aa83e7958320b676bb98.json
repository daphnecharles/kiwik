{"ast":null,"code":"/*\n *  Copyright (c) 2017 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n\n/* eslint-env node */\n'use strict';\n\nvar SDPUtils = require('sdp');\n\nfunction fixStatsType(stat) {\n  return {\n    inboundrtp: 'inbound-rtp',\n    outboundrtp: 'outbound-rtp',\n    candidatepair: 'candidate-pair',\n    localcandidate: 'local-candidate',\n    remotecandidate: 'remote-candidate'\n  }[stat.type] || stat.type;\n}\n\nfunction writeMediaSection(transceiver, caps, type, stream, dtlsRole) {\n  var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps); // Map ICE parameters (ufrag, pwd) to SDP.\n\n  sdp += SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()); // Map DTLS parameters to SDP.\n\n  sdp += SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(), type === 'offer' ? 'actpass' : dtlsRole || 'active');\n  sdp += 'a=mid:' + transceiver.mid + '\\r\\n';\n\n  if (transceiver.rtpSender && transceiver.rtpReceiver) {\n    sdp += 'a=sendrecv\\r\\n';\n  } else if (transceiver.rtpSender) {\n    sdp += 'a=sendonly\\r\\n';\n  } else if (transceiver.rtpReceiver) {\n    sdp += 'a=recvonly\\r\\n';\n  } else {\n    sdp += 'a=inactive\\r\\n';\n  }\n\n  if (transceiver.rtpSender) {\n    var trackId = transceiver.rtpSender._initialTrackId || transceiver.rtpSender.track.id;\n    transceiver.rtpSender._initialTrackId = trackId; // spec.\n\n    var msid = 'msid:' + (stream ? stream.id : '-') + ' ' + trackId + '\\r\\n';\n    sdp += 'a=' + msid; // for Chrome. Legacy should no longer be required.\n\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc + ' ' + msid; // RTX\n\n    if (transceiver.sendEncodingParameters[0].rtx) {\n      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc + ' ' + msid;\n      sdp += 'a=ssrc-group:FID ' + transceiver.sendEncodingParameters[0].ssrc + ' ' + transceiver.sendEncodingParameters[0].rtx.ssrc + '\\r\\n';\n    }\n  } // FIXME: this should be written by writeRtpDescription.\n\n\n  sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc + ' cname:' + SDPUtils.localCName + '\\r\\n';\n\n  if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc + ' cname:' + SDPUtils.localCName + '\\r\\n';\n  }\n\n  return sdp;\n} // Edge does not like\n// 1) stun: filtered after 14393 unless ?transport=udp is present\n// 2) turn: that does not have all of turn:host:port?transport=udp\n// 3) turn: with ipv6 addresses\n// 4) turn: occurring muliple times\n\n\nfunction filterIceServers(iceServers, edgeVersion) {\n  var hasTurn = false;\n  iceServers = JSON.parse(JSON.stringify(iceServers));\n  return iceServers.filter(function (server) {\n    if (server && (server.urls || server.url)) {\n      var urls = server.urls || server.url;\n\n      if (server.url && !server.urls) {\n        console.warn('RTCIceServer.url is deprecated! Use urls instead.');\n      }\n\n      var isString = typeof urls === 'string';\n\n      if (isString) {\n        urls = [urls];\n      }\n\n      urls = urls.filter(function (url) {\n        var validTurn = url.indexOf('turn:') === 0 && url.indexOf('transport=udp') !== -1 && url.indexOf('turn:[') === -1 && !hasTurn;\n\n        if (validTurn) {\n          hasTurn = true;\n          return true;\n        }\n\n        return url.indexOf('stun:') === 0 && edgeVersion >= 14393 && url.indexOf('?transport=udp') === -1;\n      });\n      delete server.url;\n      server.urls = isString ? urls[0] : urls;\n      return !!urls.length;\n    }\n  });\n} // Determines the intersection of local and remote capabilities.\n\n\nfunction getCommonCapabilities(localCapabilities, remoteCapabilities) {\n  var commonCapabilities = {\n    codecs: [],\n    headerExtensions: [],\n    fecMechanisms: []\n  };\n\n  var findCodecByPayloadType = function findCodecByPayloadType(pt, codecs) {\n    pt = parseInt(pt, 10);\n\n    for (var i = 0; i < codecs.length; i++) {\n      if (codecs[i].payloadType === pt || codecs[i].preferredPayloadType === pt) {\n        return codecs[i];\n      }\n    }\n  };\n\n  var rtxCapabilityMatches = function rtxCapabilityMatches(lRtx, rRtx, lCodecs, rCodecs) {\n    var lCodec = findCodecByPayloadType(lRtx.parameters.apt, lCodecs);\n    var rCodec = findCodecByPayloadType(rRtx.parameters.apt, rCodecs);\n    return lCodec && rCodec && lCodec.name.toLowerCase() === rCodec.name.toLowerCase();\n  };\n\n  localCapabilities.codecs.forEach(function (lCodec) {\n    for (var i = 0; i < remoteCapabilities.codecs.length; i++) {\n      var rCodec = remoteCapabilities.codecs[i];\n\n      if (lCodec.name.toLowerCase() === rCodec.name.toLowerCase() && lCodec.clockRate === rCodec.clockRate) {\n        if (lCodec.name.toLowerCase() === 'rtx' && lCodec.parameters && rCodec.parameters.apt) {\n          // for RTX we need to find the local rtx that has a apt\n          // which points to the same local codec as the remote one.\n          if (!rtxCapabilityMatches(lCodec, rCodec, localCapabilities.codecs, remoteCapabilities.codecs)) {\n            continue;\n          }\n        }\n\n        rCodec = JSON.parse(JSON.stringify(rCodec)); // deepcopy\n        // number of channels is the highest common number of channels\n\n        rCodec.numChannels = Math.min(lCodec.numChannels, rCodec.numChannels); // push rCodec so we reply with offerer payload type\n\n        commonCapabilities.codecs.push(rCodec); // determine common feedback mechanisms\n\n        rCodec.rtcpFeedback = rCodec.rtcpFeedback.filter(function (fb) {\n          for (var j = 0; j < lCodec.rtcpFeedback.length; j++) {\n            if (lCodec.rtcpFeedback[j].type === fb.type && lCodec.rtcpFeedback[j].parameter === fb.parameter) {\n              return true;\n            }\n          }\n\n          return false;\n        }); // FIXME: also need to determine .parameters\n        //  see https://github.com/openpeer/ortc/issues/569\n\n        break;\n      }\n    }\n  });\n  localCapabilities.headerExtensions.forEach(function (lHeaderExtension) {\n    for (var i = 0; i < remoteCapabilities.headerExtensions.length; i++) {\n      var rHeaderExtension = remoteCapabilities.headerExtensions[i];\n\n      if (lHeaderExtension.uri === rHeaderExtension.uri) {\n        commonCapabilities.headerExtensions.push(rHeaderExtension);\n        break;\n      }\n    }\n  }); // FIXME: fecMechanisms\n\n  return commonCapabilities;\n} // is action=setLocalDescription with type allowed in signalingState\n\n\nfunction isActionAllowedInSignalingState(action, type, signalingState) {\n  return {\n    offer: {\n      setLocalDescription: ['stable', 'have-local-offer'],\n      setRemoteDescription: ['stable', 'have-remote-offer']\n    },\n    answer: {\n      setLocalDescription: ['have-remote-offer', 'have-local-pranswer'],\n      setRemoteDescription: ['have-local-offer', 'have-remote-pranswer']\n    }\n  }[type][action].indexOf(signalingState) !== -1;\n}\n\nfunction maybeAddCandidate(iceTransport, candidate) {\n  // Edge's internal representation adds some fields therefore\n  // not all fieldÑ• are taken into account.\n  var alreadyAdded = iceTransport.getRemoteCandidates().find(function (remoteCandidate) {\n    return candidate.foundation === remoteCandidate.foundation && candidate.ip === remoteCandidate.ip && candidate.port === remoteCandidate.port && candidate.priority === remoteCandidate.priority && candidate.protocol === remoteCandidate.protocol && candidate.type === remoteCandidate.type;\n  });\n\n  if (!alreadyAdded) {\n    iceTransport.addRemoteCandidate(candidate);\n  }\n\n  return !alreadyAdded;\n}\n\nfunction makeError(name, description) {\n  var e = new Error(description);\n  e.name = name; // legacy error codes from https://heycam.github.io/webidl/#idl-DOMException-error-names\n\n  e.code = {\n    NotSupportedError: 9,\n    InvalidStateError: 11,\n    InvalidAccessError: 15,\n    TypeError: undefined,\n    OperationError: undefined\n  }[name];\n  return e;\n}\n\nmodule.exports = function (window, edgeVersion) {\n  // https://w3c.github.io/mediacapture-main/#mediastream\n  // Helper function to add the track to the stream and\n  // dispatch the event ourselves.\n  function addTrackToStreamAndFireEvent(track, stream) {\n    stream.addTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('addtrack', {\n      track: track\n    }));\n  }\n\n  function removeTrackFromStreamAndFireEvent(track, stream) {\n    stream.removeTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('removetrack', {\n      track: track\n    }));\n  }\n\n  function fireAddTrack(pc, track, receiver, streams) {\n    var trackEvent = new Event('track');\n    trackEvent.track = track;\n    trackEvent.receiver = receiver;\n    trackEvent.transceiver = {\n      receiver: receiver\n    };\n    trackEvent.streams = streams;\n    window.setTimeout(function () {\n      pc._dispatchEvent('track', trackEvent);\n    });\n  }\n\n  var RTCPeerConnection = function RTCPeerConnection(config) {\n    var pc = this;\n\n    var _eventTarget = document.createDocumentFragment();\n\n    ['addEventListener', 'removeEventListener', 'dispatchEvent'].forEach(function (method) {\n      pc[method] = _eventTarget[method].bind(_eventTarget);\n    });\n    this.canTrickleIceCandidates = null;\n    this.needNegotiation = false;\n    this.localStreams = [];\n    this.remoteStreams = [];\n    this._localDescription = null;\n    this._remoteDescription = null;\n    this.signalingState = 'stable';\n    this.iceConnectionState = 'new';\n    this.connectionState = 'new';\n    this.iceGatheringState = 'new';\n    config = JSON.parse(JSON.stringify(config || {}));\n    this.usingBundle = config.bundlePolicy === 'max-bundle';\n\n    if (config.rtcpMuxPolicy === 'negotiate') {\n      throw makeError('NotSupportedError', 'rtcpMuxPolicy \\'negotiate\\' is not supported');\n    } else if (!config.rtcpMuxPolicy) {\n      config.rtcpMuxPolicy = 'require';\n    }\n\n    switch (config.iceTransportPolicy) {\n      case 'all':\n      case 'relay':\n        break;\n\n      default:\n        config.iceTransportPolicy = 'all';\n        break;\n    }\n\n    switch (config.bundlePolicy) {\n      case 'balanced':\n      case 'max-compat':\n      case 'max-bundle':\n        break;\n\n      default:\n        config.bundlePolicy = 'balanced';\n        break;\n    }\n\n    config.iceServers = filterIceServers(config.iceServers || [], edgeVersion);\n    this._iceGatherers = [];\n\n    if (config.iceCandidatePoolSize) {\n      for (var i = config.iceCandidatePoolSize; i > 0; i--) {\n        this._iceGatherers.push(new window.RTCIceGatherer({\n          iceServers: config.iceServers,\n          gatherPolicy: config.iceTransportPolicy\n        }));\n      }\n    } else {\n      config.iceCandidatePoolSize = 0;\n    }\n\n    this._config = config; // per-track iceGathers, iceTransports, dtlsTransports, rtpSenders, ...\n    // everything that is needed to describe a SDP m-line.\n\n    this.transceivers = [];\n    this._sdpSessionId = SDPUtils.generateSessionId();\n    this._sdpSessionVersion = 0;\n    this._dtlsRole = undefined; // role for a=setup to use in answers.\n\n    this._isClosed = false;\n  };\n\n  Object.defineProperty(RTCPeerConnection.prototype, 'localDescription', {\n    configurable: true,\n    get: function get() {\n      return this._localDescription;\n    }\n  });\n  Object.defineProperty(RTCPeerConnection.prototype, 'remoteDescription', {\n    configurable: true,\n    get: function get() {\n      return this._remoteDescription;\n    }\n  }); // set up event handlers on prototype\n\n  RTCPeerConnection.prototype.onicecandidate = null;\n  RTCPeerConnection.prototype.onaddstream = null;\n  RTCPeerConnection.prototype.ontrack = null;\n  RTCPeerConnection.prototype.onremovestream = null;\n  RTCPeerConnection.prototype.onsignalingstatechange = null;\n  RTCPeerConnection.prototype.oniceconnectionstatechange = null;\n  RTCPeerConnection.prototype.onconnectionstatechange = null;\n  RTCPeerConnection.prototype.onicegatheringstatechange = null;\n  RTCPeerConnection.prototype.onnegotiationneeded = null;\n  RTCPeerConnection.prototype.ondatachannel = null;\n\n  RTCPeerConnection.prototype._dispatchEvent = function (name, event) {\n    if (this._isClosed) {\n      return;\n    }\n\n    this.dispatchEvent(event);\n\n    if (typeof this['on' + name] === 'function') {\n      this['on' + name](event);\n    }\n  };\n\n  RTCPeerConnection.prototype._emitGatheringStateChange = function () {\n    var event = new Event('icegatheringstatechange');\n\n    this._dispatchEvent('icegatheringstatechange', event);\n  };\n\n  RTCPeerConnection.prototype.getConfiguration = function () {\n    return this._config;\n  };\n\n  RTCPeerConnection.prototype.getLocalStreams = function () {\n    return this.localStreams;\n  };\n\n  RTCPeerConnection.prototype.getRemoteStreams = function () {\n    return this.remoteStreams;\n  }; // internal helper to create a transceiver object.\n  // (which is not yet the same as the WebRTC 1.0 transceiver)\n\n\n  RTCPeerConnection.prototype._createTransceiver = function (kind, doNotAdd) {\n    var hasBundleTransport = this.transceivers.length > 0;\n    var transceiver = {\n      track: null,\n      iceGatherer: null,\n      iceTransport: null,\n      dtlsTransport: null,\n      localCapabilities: null,\n      remoteCapabilities: null,\n      rtpSender: null,\n      rtpReceiver: null,\n      kind: kind,\n      mid: null,\n      sendEncodingParameters: null,\n      recvEncodingParameters: null,\n      stream: null,\n      associatedRemoteMediaStreams: [],\n      wantReceive: true\n    };\n\n    if (this.usingBundle && hasBundleTransport) {\n      transceiver.iceTransport = this.transceivers[0].iceTransport;\n      transceiver.dtlsTransport = this.transceivers[0].dtlsTransport;\n    } else {\n      var transports = this._createIceAndDtlsTransports();\n\n      transceiver.iceTransport = transports.iceTransport;\n      transceiver.dtlsTransport = transports.dtlsTransport;\n    }\n\n    if (!doNotAdd) {\n      this.transceivers.push(transceiver);\n    }\n\n    return transceiver;\n  };\n\n  RTCPeerConnection.prototype.addTrack = function (track, stream) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError', 'Attempted to call addTrack on a closed peerconnection.');\n    }\n\n    var alreadyExists = this.transceivers.find(function (s) {\n      return s.track === track;\n    });\n\n    if (alreadyExists) {\n      throw makeError('InvalidAccessError', 'Track already exists.');\n    }\n\n    var transceiver;\n\n    for (var i = 0; i < this.transceivers.length; i++) {\n      if (!this.transceivers[i].track && this.transceivers[i].kind === track.kind) {\n        transceiver = this.transceivers[i];\n      }\n    }\n\n    if (!transceiver) {\n      transceiver = this._createTransceiver(track.kind);\n    }\n\n    this._maybeFireNegotiationNeeded();\n\n    if (this.localStreams.indexOf(stream) === -1) {\n      this.localStreams.push(stream);\n    }\n\n    transceiver.track = track;\n    transceiver.stream = stream;\n    transceiver.rtpSender = new window.RTCRtpSender(track, transceiver.dtlsTransport);\n    return transceiver.rtpSender;\n  };\n\n  RTCPeerConnection.prototype.addStream = function (stream) {\n    var pc = this;\n\n    if (edgeVersion >= 15025) {\n      stream.getTracks().forEach(function (track) {\n        pc.addTrack(track, stream);\n      });\n    } else {\n      // Clone is necessary for local demos mostly, attaching directly\n      // to two different senders does not work (build 10547).\n      // Fixed in 15025 (or earlier)\n      var clonedStream = stream.clone();\n      stream.getTracks().forEach(function (track, idx) {\n        var clonedTrack = clonedStream.getTracks()[idx];\n        track.addEventListener('enabled', function (event) {\n          clonedTrack.enabled = event.enabled;\n        });\n      });\n      clonedStream.getTracks().forEach(function (track) {\n        pc.addTrack(track, clonedStream);\n      });\n    }\n  };\n\n  RTCPeerConnection.prototype.removeTrack = function (sender) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError', 'Attempted to call removeTrack on a closed peerconnection.');\n    }\n\n    if (!(sender instanceof window.RTCRtpSender)) {\n      throw new TypeError('Argument 1 of RTCPeerConnection.removeTrack ' + 'does not implement interface RTCRtpSender.');\n    }\n\n    var transceiver = this.transceivers.find(function (t) {\n      return t.rtpSender === sender;\n    });\n\n    if (!transceiver) {\n      throw makeError('InvalidAccessError', 'Sender was not created by this connection.');\n    }\n\n    var stream = transceiver.stream;\n    transceiver.rtpSender.stop();\n    transceiver.rtpSender = null;\n    transceiver.track = null;\n    transceiver.stream = null; // remove the stream from the set of local streams\n\n    var localStreams = this.transceivers.map(function (t) {\n      return t.stream;\n    });\n\n    if (localStreams.indexOf(stream) === -1 && this.localStreams.indexOf(stream) > -1) {\n      this.localStreams.splice(this.localStreams.indexOf(stream), 1);\n    }\n\n    this._maybeFireNegotiationNeeded();\n  };\n\n  RTCPeerConnection.prototype.removeStream = function (stream) {\n    var pc = this;\n    stream.getTracks().forEach(function (track) {\n      var sender = pc.getSenders().find(function (s) {\n        return s.track === track;\n      });\n\n      if (sender) {\n        pc.removeTrack(sender);\n      }\n    });\n  };\n\n  RTCPeerConnection.prototype.getSenders = function () {\n    return this.transceivers.filter(function (transceiver) {\n      return !!transceiver.rtpSender;\n    }).map(function (transceiver) {\n      return transceiver.rtpSender;\n    });\n  };\n\n  RTCPeerConnection.prototype.getReceivers = function () {\n    return this.transceivers.filter(function (transceiver) {\n      return !!transceiver.rtpReceiver;\n    }).map(function (transceiver) {\n      return transceiver.rtpReceiver;\n    });\n  };\n\n  RTCPeerConnection.prototype._createIceGatherer = function (sdpMLineIndex, usingBundle) {\n    var pc = this;\n\n    if (usingBundle && sdpMLineIndex > 0) {\n      return this.transceivers[0].iceGatherer;\n    } else if (this._iceGatherers.length) {\n      return this._iceGatherers.shift();\n    }\n\n    var iceGatherer = new window.RTCIceGatherer({\n      iceServers: this._config.iceServers,\n      gatherPolicy: this._config.iceTransportPolicy\n    });\n    Object.defineProperty(iceGatherer, 'state', {\n      value: 'new',\n      writable: true\n    });\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = [];\n\n    this.transceivers[sdpMLineIndex].bufferCandidates = function (event) {\n      var end = !event.candidate || Object.keys(event.candidate).length === 0; // polyfill since RTCIceGatherer.state is not implemented in\n      // Edge 10547 yet.\n\n      iceGatherer.state = end ? 'completed' : 'gathering';\n\n      if (pc.transceivers[sdpMLineIndex].bufferedCandidateEvents !== null) {\n        pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event);\n      }\n    };\n\n    iceGatherer.addEventListener('localcandidate', this.transceivers[sdpMLineIndex].bufferCandidates);\n    return iceGatherer;\n  }; // start gathering from an RTCIceGatherer.\n\n\n  RTCPeerConnection.prototype._gather = function (mid, sdpMLineIndex) {\n    var pc = this;\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n\n    if (iceGatherer.onlocalcandidate) {\n      return;\n    }\n\n    var bufferedCandidateEvents = this.transceivers[sdpMLineIndex].bufferedCandidateEvents;\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = null;\n    iceGatherer.removeEventListener('localcandidate', this.transceivers[sdpMLineIndex].bufferCandidates);\n\n    iceGatherer.onlocalcandidate = function (evt) {\n      if (pc.usingBundle && sdpMLineIndex > 0) {\n        // if we know that we use bundle we can drop candidates with\n        // Ñ•dpMLineIndex > 0. If we don't do this then our state gets\n        // confused since we dispose the extra ice gatherer.\n        return;\n      }\n\n      var event = new Event('icecandidate');\n      event.candidate = {\n        sdpMid: mid,\n        sdpMLineIndex: sdpMLineIndex\n      };\n      var cand = evt.candidate; // Edge emits an empty object for RTCIceCandidateCompleteâ€¥\n\n      var end = !cand || Object.keys(cand).length === 0;\n\n      if (end) {\n        // polyfill since RTCIceGatherer.state is not implemented in\n        // Edge 10547 yet.\n        if (iceGatherer.state === 'new' || iceGatherer.state === 'gathering') {\n          iceGatherer.state = 'completed';\n        }\n      } else {\n        if (iceGatherer.state === 'new') {\n          iceGatherer.state = 'gathering';\n        } // RTCIceCandidate doesn't have a component, needs to be added\n\n\n        cand.component = 1; // also the usernameFragment. TODO: update SDP to take both variants.\n\n        cand.ufrag = iceGatherer.getLocalParameters().usernameFragment;\n        var serializedCandidate = SDPUtils.writeCandidate(cand);\n        event.candidate = Object.assign(event.candidate, SDPUtils.parseCandidate(serializedCandidate));\n        event.candidate.candidate = serializedCandidate;\n\n        event.candidate.toJSON = function () {\n          return {\n            candidate: event.candidate.candidate,\n            sdpMid: event.candidate.sdpMid,\n            sdpMLineIndex: event.candidate.sdpMLineIndex,\n            usernameFragment: event.candidate.usernameFragment\n          };\n        };\n      } // update local description.\n\n\n      var sections = SDPUtils.getMediaSections(pc._localDescription.sdp);\n\n      if (!end) {\n        sections[event.candidate.sdpMLineIndex] += 'a=' + event.candidate.candidate + '\\r\\n';\n      } else {\n        sections[event.candidate.sdpMLineIndex] += 'a=end-of-candidates\\r\\n';\n      }\n\n      pc._localDescription.sdp = SDPUtils.getDescription(pc._localDescription.sdp) + sections.join('');\n      var complete = pc.transceivers.every(function (transceiver) {\n        return transceiver.iceGatherer && transceiver.iceGatherer.state === 'completed';\n      });\n\n      if (pc.iceGatheringState !== 'gathering') {\n        pc.iceGatheringState = 'gathering';\n\n        pc._emitGatheringStateChange();\n      } // Emit candidate. Also emit null candidate when all gatherers are\n      // complete.\n\n\n      if (!end) {\n        pc._dispatchEvent('icecandidate', event);\n      }\n\n      if (complete) {\n        pc._dispatchEvent('icecandidate', new Event('icecandidate'));\n\n        pc.iceGatheringState = 'complete';\n\n        pc._emitGatheringStateChange();\n      }\n    }; // emit already gathered candidates.\n\n\n    window.setTimeout(function () {\n      bufferedCandidateEvents.forEach(function (e) {\n        iceGatherer.onlocalcandidate(e);\n      });\n    }, 0);\n  }; // Create ICE transport and DTLS transport.\n\n\n  RTCPeerConnection.prototype._createIceAndDtlsTransports = function () {\n    var pc = this;\n    var iceTransport = new window.RTCIceTransport(null);\n\n    iceTransport.onicestatechange = function () {\n      pc._updateIceConnectionState();\n\n      pc._updateConnectionState();\n    };\n\n    var dtlsTransport = new window.RTCDtlsTransport(iceTransport);\n\n    dtlsTransport.ondtlsstatechange = function () {\n      pc._updateConnectionState();\n    };\n\n    dtlsTransport.onerror = function () {\n      // onerror does not set state to failed by itself.\n      Object.defineProperty(dtlsTransport, 'state', {\n        value: 'failed',\n        writable: true\n      });\n\n      pc._updateConnectionState();\n    };\n\n    return {\n      iceTransport: iceTransport,\n      dtlsTransport: dtlsTransport\n    };\n  }; // Destroy ICE gatherer, ICE transport and DTLS transport.\n  // Without triggering the callbacks.\n\n\n  RTCPeerConnection.prototype._disposeIceAndDtlsTransports = function (sdpMLineIndex) {\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n\n    if (iceGatherer) {\n      delete iceGatherer.onlocalcandidate;\n      delete this.transceivers[sdpMLineIndex].iceGatherer;\n    }\n\n    var iceTransport = this.transceivers[sdpMLineIndex].iceTransport;\n\n    if (iceTransport) {\n      delete iceTransport.onicestatechange;\n      delete this.transceivers[sdpMLineIndex].iceTransport;\n    }\n\n    var dtlsTransport = this.transceivers[sdpMLineIndex].dtlsTransport;\n\n    if (dtlsTransport) {\n      delete dtlsTransport.ondtlsstatechange;\n      delete dtlsTransport.onerror;\n      delete this.transceivers[sdpMLineIndex].dtlsTransport;\n    }\n  }; // Start the RTP Sender and Receiver for a transceiver.\n\n\n  RTCPeerConnection.prototype._transceive = function (transceiver, send, recv) {\n    var params = getCommonCapabilities(transceiver.localCapabilities, transceiver.remoteCapabilities);\n\n    if (send && transceiver.rtpSender) {\n      params.encodings = transceiver.sendEncodingParameters;\n      params.rtcp = {\n        cname: SDPUtils.localCName,\n        compound: transceiver.rtcpParameters.compound\n      };\n\n      if (transceiver.recvEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.recvEncodingParameters[0].ssrc;\n      }\n\n      transceiver.rtpSender.send(params);\n    }\n\n    if (recv && transceiver.rtpReceiver && params.codecs.length > 0) {\n      // remove RTX field in Edge 14942\n      if (transceiver.kind === 'video' && transceiver.recvEncodingParameters && edgeVersion < 15019) {\n        transceiver.recvEncodingParameters.forEach(function (p) {\n          delete p.rtx;\n        });\n      }\n\n      if (transceiver.recvEncodingParameters.length) {\n        params.encodings = transceiver.recvEncodingParameters;\n      } else {\n        params.encodings = [{}];\n      }\n\n      params.rtcp = {\n        compound: transceiver.rtcpParameters.compound\n      };\n\n      if (transceiver.rtcpParameters.cname) {\n        params.rtcp.cname = transceiver.rtcpParameters.cname;\n      }\n\n      if (transceiver.sendEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.sendEncodingParameters[0].ssrc;\n      }\n\n      transceiver.rtpReceiver.receive(params);\n    }\n  };\n\n  RTCPeerConnection.prototype.setLocalDescription = function (description) {\n    var pc = this; // Note: pranswer is not supported.\n\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError', 'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setLocalDescription', description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not set local ' + description.type + ' in state ' + pc.signalingState));\n    }\n\n    var sections;\n    var sessionpart;\n\n    if (description.type === 'offer') {\n      // VERY limited support for SDP munging. Limited to:\n      // * changing the order of codecs\n      sections = SDPUtils.splitSections(description.sdp);\n      sessionpart = sections.shift();\n      sections.forEach(function (mediaSection, sdpMLineIndex) {\n        var caps = SDPUtils.parseRtpParameters(mediaSection);\n        pc.transceivers[sdpMLineIndex].localCapabilities = caps;\n      });\n      pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n        pc._gather(transceiver.mid, sdpMLineIndex);\n      });\n    } else if (description.type === 'answer') {\n      sections = SDPUtils.splitSections(pc._remoteDescription.sdp);\n      sessionpart = sections.shift();\n      var isIceLite = SDPUtils.matchPrefix(sessionpart, 'a=ice-lite').length > 0;\n      sections.forEach(function (mediaSection, sdpMLineIndex) {\n        var transceiver = pc.transceivers[sdpMLineIndex];\n        var iceGatherer = transceiver.iceGatherer;\n        var iceTransport = transceiver.iceTransport;\n        var dtlsTransport = transceiver.dtlsTransport;\n        var localCapabilities = transceiver.localCapabilities;\n        var remoteCapabilities = transceiver.remoteCapabilities; // treat bundle-only as not-rejected.\n\n        var rejected = SDPUtils.isRejected(mediaSection) && SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n\n        if (!rejected && !transceiver.rejected) {\n          var remoteIceParameters = SDPUtils.getIceParameters(mediaSection, sessionpart);\n          var remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection, sessionpart);\n\n          if (isIceLite) {\n            remoteDtlsParameters.role = 'server';\n          }\n\n          if (!pc.usingBundle || sdpMLineIndex === 0) {\n            pc._gather(transceiver.mid, sdpMLineIndex);\n\n            if (iceTransport.state === 'new') {\n              iceTransport.start(iceGatherer, remoteIceParameters, isIceLite ? 'controlling' : 'controlled');\n            }\n\n            if (dtlsTransport.state === 'new') {\n              dtlsTransport.start(remoteDtlsParameters);\n            }\n          } // Calculate intersection of capabilities.\n\n\n          var params = getCommonCapabilities(localCapabilities, remoteCapabilities); // Start the RTCRtpSender. The RTCRtpReceiver for this\n          // transceiver has already been started in setRemoteDescription.\n\n          pc._transceive(transceiver, params.codecs.length > 0, false);\n        }\n      });\n    }\n\n    pc._localDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-local-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.setRemoteDescription = function (description) {\n    var pc = this; // Note: pranswer is not supported.\n\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError', 'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setRemoteDescription', description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not set remote ' + description.type + ' in state ' + pc.signalingState));\n    }\n\n    var streams = {};\n    pc.remoteStreams.forEach(function (stream) {\n      streams[stream.id] = stream;\n    });\n    var receiverList = [];\n    var sections = SDPUtils.splitSections(description.sdp);\n    var sessionpart = sections.shift();\n    var isIceLite = SDPUtils.matchPrefix(sessionpart, 'a=ice-lite').length > 0;\n    var usingBundle = SDPUtils.matchPrefix(sessionpart, 'a=group:BUNDLE ').length > 0;\n    pc.usingBundle = usingBundle;\n    var iceOptions = SDPUtils.matchPrefix(sessionpart, 'a=ice-options:')[0];\n\n    if (iceOptions) {\n      pc.canTrickleIceCandidates = iceOptions.substr(14).split(' ').indexOf('trickle') >= 0;\n    } else {\n      pc.canTrickleIceCandidates = false;\n    }\n\n    sections.forEach(function (mediaSection, sdpMLineIndex) {\n      var lines = SDPUtils.splitLines(mediaSection);\n      var kind = SDPUtils.getKind(mediaSection); // treat bundle-only as not-rejected.\n\n      var rejected = SDPUtils.isRejected(mediaSection) && SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n      var protocol = lines[0].substr(2).split(' ')[2];\n      var direction = SDPUtils.getDirection(mediaSection, sessionpart);\n      var remoteMsid = SDPUtils.parseMsid(mediaSection);\n      var mid = SDPUtils.getMid(mediaSection) || SDPUtils.generateIdentifier(); // Reject datachannels which are not implemented yet.\n\n      if (rejected || kind === 'application' && (protocol === 'DTLS/SCTP' || protocol === 'UDP/DTLS/SCTP')) {\n        // TODO: this is dangerous in the case where a non-rejected m-line\n        //     becomes rejected.\n        pc.transceivers[sdpMLineIndex] = {\n          mid: mid,\n          kind: kind,\n          protocol: protocol,\n          rejected: true\n        };\n        return;\n      }\n\n      if (!rejected && pc.transceivers[sdpMLineIndex] && pc.transceivers[sdpMLineIndex].rejected) {\n        // recycle a rejected transceiver.\n        pc.transceivers[sdpMLineIndex] = pc._createTransceiver(kind, true);\n      }\n\n      var transceiver;\n      var iceGatherer;\n      var iceTransport;\n      var dtlsTransport;\n      var rtpReceiver;\n      var sendEncodingParameters;\n      var recvEncodingParameters;\n      var localCapabilities;\n      var track; // FIXME: ensure the mediaSection has rtcp-mux set.\n\n      var remoteCapabilities = SDPUtils.parseRtpParameters(mediaSection);\n      var remoteIceParameters;\n      var remoteDtlsParameters;\n\n      if (!rejected) {\n        remoteIceParameters = SDPUtils.getIceParameters(mediaSection, sessionpart);\n        remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection, sessionpart);\n        remoteDtlsParameters.role = 'client';\n      }\n\n      recvEncodingParameters = SDPUtils.parseRtpEncodingParameters(mediaSection);\n      var rtcpParameters = SDPUtils.parseRtcpParameters(mediaSection);\n      var isComplete = SDPUtils.matchPrefix(mediaSection, 'a=end-of-candidates', sessionpart).length > 0;\n      var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:').map(function (cand) {\n        return SDPUtils.parseCandidate(cand);\n      }).filter(function (cand) {\n        return cand.component === 1;\n      }); // Check if we can use BUNDLE and dispose transports.\n\n      if ((description.type === 'offer' || description.type === 'answer') && !rejected && usingBundle && sdpMLineIndex > 0 && pc.transceivers[sdpMLineIndex]) {\n        pc._disposeIceAndDtlsTransports(sdpMLineIndex);\n\n        pc.transceivers[sdpMLineIndex].iceGatherer = pc.transceivers[0].iceGatherer;\n        pc.transceivers[sdpMLineIndex].iceTransport = pc.transceivers[0].iceTransport;\n        pc.transceivers[sdpMLineIndex].dtlsTransport = pc.transceivers[0].dtlsTransport;\n\n        if (pc.transceivers[sdpMLineIndex].rtpSender) {\n          pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport);\n        }\n\n        if (pc.transceivers[sdpMLineIndex].rtpReceiver) {\n          pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport);\n        }\n      }\n\n      if (description.type === 'offer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex] || pc._createTransceiver(kind);\n        transceiver.mid = mid;\n\n        if (!transceiver.iceGatherer) {\n          transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex, usingBundle);\n        }\n\n        if (cands.length && transceiver.iceTransport.state === 'new') {\n          if (isComplete && (!usingBundle || sdpMLineIndex === 0)) {\n            transceiver.iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function (candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        localCapabilities = window.RTCRtpReceiver.getCapabilities(kind); // filter RTX until additional stuff needed for RTX is implemented\n        // in adapter.js\n\n        if (edgeVersion < 15019) {\n          localCapabilities.codecs = localCapabilities.codecs.filter(function (codec) {\n            return codec.name !== 'rtx';\n          });\n        }\n\n        sendEncodingParameters = transceiver.sendEncodingParameters || [{\n          ssrc: (2 * sdpMLineIndex + 2) * 1001\n        }]; // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n\n        var isNewTrack = false;\n\n        if (direction === 'sendrecv' || direction === 'sendonly') {\n          isNewTrack = !transceiver.rtpReceiver;\n          rtpReceiver = transceiver.rtpReceiver || new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);\n\n          if (isNewTrack) {\n            var stream;\n            track = rtpReceiver.track; // FIXME: does not work with Plan B.\n\n            if (remoteMsid && remoteMsid.stream === '-') {// no-op. a stream id of '-' means: no associated stream.\n            } else if (remoteMsid) {\n              if (!streams[remoteMsid.stream]) {\n                streams[remoteMsid.stream] = new window.MediaStream();\n                Object.defineProperty(streams[remoteMsid.stream], 'id', {\n                  get: function get() {\n                    return remoteMsid.stream;\n                  }\n                });\n              }\n\n              Object.defineProperty(track, 'id', {\n                get: function get() {\n                  return remoteMsid.track;\n                }\n              });\n              stream = streams[remoteMsid.stream];\n            } else {\n              if (!streams.default) {\n                streams.default = new window.MediaStream();\n              }\n\n              stream = streams.default;\n            }\n\n            if (stream) {\n              addTrackToStreamAndFireEvent(track, stream);\n              transceiver.associatedRemoteMediaStreams.push(stream);\n            }\n\n            receiverList.push([track, rtpReceiver, stream]);\n          }\n        } else if (transceiver.rtpReceiver && transceiver.rtpReceiver.track) {\n          transceiver.associatedRemoteMediaStreams.forEach(function (s) {\n            var nativeTrack = s.getTracks().find(function (t) {\n              return t.id === transceiver.rtpReceiver.track.id;\n            });\n\n            if (nativeTrack) {\n              removeTrackFromStreamAndFireEvent(nativeTrack, s);\n            }\n          });\n          transceiver.associatedRemoteMediaStreams = [];\n        }\n\n        transceiver.localCapabilities = localCapabilities;\n        transceiver.remoteCapabilities = remoteCapabilities;\n        transceiver.rtpReceiver = rtpReceiver;\n        transceiver.rtcpParameters = rtcpParameters;\n        transceiver.sendEncodingParameters = sendEncodingParameters;\n        transceiver.recvEncodingParameters = recvEncodingParameters; // Start the RTCRtpReceiver now. The RTPSender is started in\n        // setLocalDescription.\n\n        pc._transceive(pc.transceivers[sdpMLineIndex], false, isNewTrack);\n      } else if (description.type === 'answer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex];\n        iceGatherer = transceiver.iceGatherer;\n        iceTransport = transceiver.iceTransport;\n        dtlsTransport = transceiver.dtlsTransport;\n        rtpReceiver = transceiver.rtpReceiver;\n        sendEncodingParameters = transceiver.sendEncodingParameters;\n        localCapabilities = transceiver.localCapabilities;\n        pc.transceivers[sdpMLineIndex].recvEncodingParameters = recvEncodingParameters;\n        pc.transceivers[sdpMLineIndex].remoteCapabilities = remoteCapabilities;\n        pc.transceivers[sdpMLineIndex].rtcpParameters = rtcpParameters;\n\n        if (cands.length && iceTransport.state === 'new') {\n          if ((isIceLite || isComplete) && (!usingBundle || sdpMLineIndex === 0)) {\n            iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function (candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        if (!usingBundle || sdpMLineIndex === 0) {\n          if (iceTransport.state === 'new') {\n            iceTransport.start(iceGatherer, remoteIceParameters, 'controlling');\n          }\n\n          if (dtlsTransport.state === 'new') {\n            dtlsTransport.start(remoteDtlsParameters);\n          }\n        } // If the offer contained RTX but the answer did not,\n        // remove RTX from sendEncodingParameters.\n\n\n        var commonCapabilities = getCommonCapabilities(transceiver.localCapabilities, transceiver.remoteCapabilities);\n        var hasRtx = commonCapabilities.codecs.filter(function (c) {\n          return c.name.toLowerCase() === 'rtx';\n        }).length;\n\n        if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {\n          delete transceiver.sendEncodingParameters[0].rtx;\n        }\n\n        pc._transceive(transceiver, direction === 'sendrecv' || direction === 'recvonly', direction === 'sendrecv' || direction === 'sendonly'); // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n\n\n        if (rtpReceiver && (direction === 'sendrecv' || direction === 'sendonly')) {\n          track = rtpReceiver.track;\n\n          if (remoteMsid) {\n            if (!streams[remoteMsid.stream]) {\n              streams[remoteMsid.stream] = new window.MediaStream();\n            }\n\n            addTrackToStreamAndFireEvent(track, streams[remoteMsid.stream]);\n            receiverList.push([track, rtpReceiver, streams[remoteMsid.stream]]);\n          } else {\n            if (!streams.default) {\n              streams.default = new window.MediaStream();\n            }\n\n            addTrackToStreamAndFireEvent(track, streams.default);\n            receiverList.push([track, rtpReceiver, streams.default]);\n          }\n        } else {\n          // FIXME: actually the receiver should be created later.\n          delete transceiver.rtpReceiver;\n        }\n      }\n    });\n\n    if (pc._dtlsRole === undefined) {\n      pc._dtlsRole = description.type === 'offer' ? 'active' : 'passive';\n    }\n\n    pc._remoteDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-remote-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n\n    Object.keys(streams).forEach(function (sid) {\n      var stream = streams[sid];\n\n      if (stream.getTracks().length) {\n        if (pc.remoteStreams.indexOf(stream) === -1) {\n          pc.remoteStreams.push(stream);\n          var event = new Event('addstream');\n          event.stream = stream;\n          window.setTimeout(function () {\n            pc._dispatchEvent('addstream', event);\n          });\n        }\n\n        receiverList.forEach(function (item) {\n          var track = item[0];\n          var receiver = item[1];\n\n          if (stream.id !== item[2].id) {\n            return;\n          }\n\n          fireAddTrack(pc, track, receiver, [stream]);\n        });\n      }\n    });\n    receiverList.forEach(function (item) {\n      if (item[2]) {\n        return;\n      }\n\n      fireAddTrack(pc, item[0], item[1], []);\n    }); // check whether addIceCandidate({}) was called within four seconds after\n    // setRemoteDescription.\n\n    window.setTimeout(function () {\n      if (!(pc && pc.transceivers)) {\n        return;\n      }\n\n      pc.transceivers.forEach(function (transceiver) {\n        if (transceiver.iceTransport && transceiver.iceTransport.state === 'new' && transceiver.iceTransport.getRemoteCandidates().length > 0) {\n          console.warn('Timeout for addRemoteCandidate. Consider sending ' + 'an end-of-candidates notification');\n          transceiver.iceTransport.addRemoteCandidate({});\n        }\n      });\n    }, 4000);\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.close = function () {\n    this.transceivers.forEach(function (transceiver) {\n      /* not yet\n      if (transceiver.iceGatherer) {\n        transceiver.iceGatherer.close();\n      }\n      */\n      if (transceiver.iceTransport) {\n        transceiver.iceTransport.stop();\n      }\n\n      if (transceiver.dtlsTransport) {\n        transceiver.dtlsTransport.stop();\n      }\n\n      if (transceiver.rtpSender) {\n        transceiver.rtpSender.stop();\n      }\n\n      if (transceiver.rtpReceiver) {\n        transceiver.rtpReceiver.stop();\n      }\n    }); // FIXME: clean up tracks, local streams, remote streams, etc\n\n    this._isClosed = true;\n\n    this._updateSignalingState('closed');\n  }; // Update the signaling state.\n\n\n  RTCPeerConnection.prototype._updateSignalingState = function (newState) {\n    this.signalingState = newState;\n    var event = new Event('signalingstatechange');\n\n    this._dispatchEvent('signalingstatechange', event);\n  }; // Determine whether to fire the negotiationneeded event.\n\n\n  RTCPeerConnection.prototype._maybeFireNegotiationNeeded = function () {\n    var pc = this;\n\n    if (this.signalingState !== 'stable' || this.needNegotiation === true) {\n      return;\n    }\n\n    this.needNegotiation = true;\n    window.setTimeout(function () {\n      if (pc.needNegotiation) {\n        pc.needNegotiation = false;\n        var event = new Event('negotiationneeded');\n\n        pc._dispatchEvent('negotiationneeded', event);\n      }\n    }, 0);\n  }; // Update the ice connection state.\n\n\n  RTCPeerConnection.prototype._updateIceConnectionState = function () {\n    var newState;\n    var states = {\n      'new': 0,\n      closed: 0,\n      checking: 0,\n      connected: 0,\n      completed: 0,\n      disconnected: 0,\n      failed: 0\n    };\n    this.transceivers.forEach(function (transceiver) {\n      if (transceiver.iceTransport && !transceiver.rejected) {\n        states[transceiver.iceTransport.state]++;\n      }\n    });\n    newState = 'new';\n\n    if (states.failed > 0) {\n      newState = 'failed';\n    } else if (states.checking > 0) {\n      newState = 'checking';\n    } else if (states.disconnected > 0) {\n      newState = 'disconnected';\n    } else if (states.new > 0) {\n      newState = 'new';\n    } else if (states.connected > 0) {\n      newState = 'connected';\n    } else if (states.completed > 0) {\n      newState = 'completed';\n    }\n\n    if (newState !== this.iceConnectionState) {\n      this.iceConnectionState = newState;\n      var event = new Event('iceconnectionstatechange');\n\n      this._dispatchEvent('iceconnectionstatechange', event);\n    }\n  }; // Update the connection state.\n\n\n  RTCPeerConnection.prototype._updateConnectionState = function () {\n    var newState;\n    var states = {\n      'new': 0,\n      closed: 0,\n      connecting: 0,\n      connected: 0,\n      completed: 0,\n      disconnected: 0,\n      failed: 0\n    };\n    this.transceivers.forEach(function (transceiver) {\n      if (transceiver.iceTransport && transceiver.dtlsTransport && !transceiver.rejected) {\n        states[transceiver.iceTransport.state]++;\n        states[transceiver.dtlsTransport.state]++;\n      }\n    }); // ICETransport.completed and connected are the same for this purpose.\n\n    states.connected += states.completed;\n    newState = 'new';\n\n    if (states.failed > 0) {\n      newState = 'failed';\n    } else if (states.connecting > 0) {\n      newState = 'connecting';\n    } else if (states.disconnected > 0) {\n      newState = 'disconnected';\n    } else if (states.new > 0) {\n      newState = 'new';\n    } else if (states.connected > 0) {\n      newState = 'connected';\n    }\n\n    if (newState !== this.connectionState) {\n      this.connectionState = newState;\n      var event = new Event('connectionstatechange');\n\n      this._dispatchEvent('connectionstatechange', event);\n    }\n  };\n\n  RTCPeerConnection.prototype.createOffer = function () {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not call createOffer after close'));\n    }\n\n    var numAudioTracks = pc.transceivers.filter(function (t) {\n      return t.kind === 'audio';\n    }).length;\n    var numVideoTracks = pc.transceivers.filter(function (t) {\n      return t.kind === 'video';\n    }).length; // Determine number of audio and video tracks we need to send/recv.\n\n    var offerOptions = arguments[0];\n\n    if (offerOptions) {\n      // Reject Chrome legacy constraints.\n      if (offerOptions.mandatory || offerOptions.optional) {\n        throw new TypeError('Legacy mandatory/optional constraints not supported.');\n      }\n\n      if (offerOptions.offerToReceiveAudio !== undefined) {\n        if (offerOptions.offerToReceiveAudio === true) {\n          numAudioTracks = 1;\n        } else if (offerOptions.offerToReceiveAudio === false) {\n          numAudioTracks = 0;\n        } else {\n          numAudioTracks = offerOptions.offerToReceiveAudio;\n        }\n      }\n\n      if (offerOptions.offerToReceiveVideo !== undefined) {\n        if (offerOptions.offerToReceiveVideo === true) {\n          numVideoTracks = 1;\n        } else if (offerOptions.offerToReceiveVideo === false) {\n          numVideoTracks = 0;\n        } else {\n          numVideoTracks = offerOptions.offerToReceiveVideo;\n        }\n      }\n    }\n\n    pc.transceivers.forEach(function (transceiver) {\n      if (transceiver.kind === 'audio') {\n        numAudioTracks--;\n\n        if (numAudioTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      } else if (transceiver.kind === 'video') {\n        numVideoTracks--;\n\n        if (numVideoTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      }\n    }); // Create M-lines for recvonly streams.\n\n    while (numAudioTracks > 0 || numVideoTracks > 0) {\n      if (numAudioTracks > 0) {\n        pc._createTransceiver('audio');\n\n        numAudioTracks--;\n      }\n\n      if (numVideoTracks > 0) {\n        pc._createTransceiver('video');\n\n        numVideoTracks--;\n      }\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId, pc._sdpSessionVersion++);\n    pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n      // For each track, create an ice gatherer, ice transport,\n      // dtls transport, potentially rtpsender and rtpreceiver.\n      var track = transceiver.track;\n      var kind = transceiver.kind;\n      var mid = transceiver.mid || SDPUtils.generateIdentifier();\n      transceiver.mid = mid;\n\n      if (!transceiver.iceGatherer) {\n        transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex, pc.usingBundle);\n      }\n\n      var localCapabilities = window.RTCRtpSender.getCapabilities(kind); // filter RTX until additional stuff needed for RTX is implemented\n      // in adapter.js\n\n      if (edgeVersion < 15019) {\n        localCapabilities.codecs = localCapabilities.codecs.filter(function (codec) {\n          return codec.name !== 'rtx';\n        });\n      }\n\n      localCapabilities.codecs.forEach(function (codec) {\n        // work around https://bugs.chromium.org/p/webrtc/issues/detail?id=6552\n        // by adding level-asymmetry-allowed=1\n        if (codec.name === 'H264' && codec.parameters['level-asymmetry-allowed'] === undefined) {\n          codec.parameters['level-asymmetry-allowed'] = '1';\n        } // for subsequent offers, we might have to re-use the payload\n        // type of the last offer.\n\n\n        if (transceiver.remoteCapabilities && transceiver.remoteCapabilities.codecs) {\n          transceiver.remoteCapabilities.codecs.forEach(function (remoteCodec) {\n            if (codec.name.toLowerCase() === remoteCodec.name.toLowerCase() && codec.clockRate === remoteCodec.clockRate) {\n              codec.preferredPayloadType = remoteCodec.payloadType;\n            }\n          });\n        }\n      });\n      localCapabilities.headerExtensions.forEach(function (hdrExt) {\n        var remoteExtensions = transceiver.remoteCapabilities && transceiver.remoteCapabilities.headerExtensions || [];\n        remoteExtensions.forEach(function (rHdrExt) {\n          if (hdrExt.uri === rHdrExt.uri) {\n            hdrExt.id = rHdrExt.id;\n          }\n        });\n      }); // generate an ssrc now, to be used later in rtpSender.send\n\n      var sendEncodingParameters = transceiver.sendEncodingParameters || [{\n        ssrc: (2 * sdpMLineIndex + 1) * 1001\n      }];\n\n      if (track) {\n        // add RTX\n        if (edgeVersion >= 15019 && kind === 'video' && !sendEncodingParameters[0].rtx) {\n          sendEncodingParameters[0].rtx = {\n            ssrc: sendEncodingParameters[0].ssrc + 1\n          };\n        }\n      }\n\n      if (transceiver.wantReceive) {\n        transceiver.rtpReceiver = new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);\n      }\n\n      transceiver.localCapabilities = localCapabilities;\n      transceiver.sendEncodingParameters = sendEncodingParameters;\n    }); // always offer BUNDLE and dispose on return if not supported.\n\n    if (pc._config.bundlePolicy !== 'max-compat') {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function (t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n\n    sdp += 'a=ice-options:trickle\\r\\n';\n    pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n      sdp += writeMediaSection(transceiver, transceiver.localCapabilities, 'offer', transceiver.stream, pc._dtlsRole);\n      sdp += 'a=rtcp-rsize\\r\\n';\n\n      if (transceiver.iceGatherer && pc.iceGatheringState !== 'new' && (sdpMLineIndex === 0 || !pc.usingBundle)) {\n        transceiver.iceGatherer.getLocalCandidates().forEach(function (cand) {\n          cand.component = 1;\n          sdp += 'a=' + SDPUtils.writeCandidate(cand) + '\\r\\n';\n        });\n\n        if (transceiver.iceGatherer.state === 'completed') {\n          sdp += 'a=end-of-candidates\\r\\n';\n        }\n      }\n    });\n    var desc = new window.RTCSessionDescription({\n      type: 'offer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.createAnswer = function () {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not call createAnswer after close'));\n    }\n\n    if (!(pc.signalingState === 'have-remote-offer' || pc.signalingState === 'have-local-pranswer')) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not call createAnswer in signalingState ' + pc.signalingState));\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId, pc._sdpSessionVersion++);\n\n    if (pc.usingBundle) {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function (t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n\n    sdp += 'a=ice-options:trickle\\r\\n';\n    var mediaSectionsInOffer = SDPUtils.getMediaSections(pc._remoteDescription.sdp).length;\n    pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n      if (sdpMLineIndex + 1 > mediaSectionsInOffer) {\n        return;\n      }\n\n      if (transceiver.rejected) {\n        if (transceiver.kind === 'application') {\n          if (transceiver.protocol === 'DTLS/SCTP') {\n            // legacy fmt\n            sdp += 'm=application 0 DTLS/SCTP 5000\\r\\n';\n          } else {\n            sdp += 'm=application 0 ' + transceiver.protocol + ' webrtc-datachannel\\r\\n';\n          }\n        } else if (transceiver.kind === 'audio') {\n          sdp += 'm=audio 0 UDP/TLS/RTP/SAVPF 0\\r\\n' + 'a=rtpmap:0 PCMU/8000\\r\\n';\n        } else if (transceiver.kind === 'video') {\n          sdp += 'm=video 0 UDP/TLS/RTP/SAVPF 120\\r\\n' + 'a=rtpmap:120 VP8/90000\\r\\n';\n        }\n\n        sdp += 'c=IN IP4 0.0.0.0\\r\\n' + 'a=inactive\\r\\n' + 'a=mid:' + transceiver.mid + '\\r\\n';\n        return;\n      } // FIXME: look at direction.\n\n\n      if (transceiver.stream) {\n        var localTrack;\n\n        if (transceiver.kind === 'audio') {\n          localTrack = transceiver.stream.getAudioTracks()[0];\n        } else if (transceiver.kind === 'video') {\n          localTrack = transceiver.stream.getVideoTracks()[0];\n        }\n\n        if (localTrack) {\n          // add RTX\n          if (edgeVersion >= 15019 && transceiver.kind === 'video' && !transceiver.sendEncodingParameters[0].rtx) {\n            transceiver.sendEncodingParameters[0].rtx = {\n              ssrc: transceiver.sendEncodingParameters[0].ssrc + 1\n            };\n          }\n        }\n      } // Calculate intersection of capabilities.\n\n\n      var commonCapabilities = getCommonCapabilities(transceiver.localCapabilities, transceiver.remoteCapabilities);\n      var hasRtx = commonCapabilities.codecs.filter(function (c) {\n        return c.name.toLowerCase() === 'rtx';\n      }).length;\n\n      if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {\n        delete transceiver.sendEncodingParameters[0].rtx;\n      }\n\n      sdp += writeMediaSection(transceiver, commonCapabilities, 'answer', transceiver.stream, pc._dtlsRole);\n\n      if (transceiver.rtcpParameters && transceiver.rtcpParameters.reducedSize) {\n        sdp += 'a=rtcp-rsize\\r\\n';\n      }\n    });\n    var desc = new window.RTCSessionDescription({\n      type: 'answer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.addIceCandidate = function (candidate) {\n    var pc = this;\n    var sections;\n\n    if (candidate && !(candidate.sdpMLineIndex !== undefined || candidate.sdpMid)) {\n      return Promise.reject(new TypeError('sdpMLineIndex or sdpMid required'));\n    } // TODO: needs to go into ops queue.\n\n\n    return new Promise(function (resolve, reject) {\n      if (!pc._remoteDescription) {\n        return reject(makeError('InvalidStateError', 'Can not add ICE candidate without a remote description'));\n      } else if (!candidate || candidate.candidate === '') {\n        for (var j = 0; j < pc.transceivers.length; j++) {\n          if (pc.transceivers[j].rejected) {\n            continue;\n          }\n\n          pc.transceivers[j].iceTransport.addRemoteCandidate({});\n          sections = SDPUtils.getMediaSections(pc._remoteDescription.sdp);\n          sections[j] += 'a=end-of-candidates\\r\\n';\n          pc._remoteDescription.sdp = SDPUtils.getDescription(pc._remoteDescription.sdp) + sections.join('');\n\n          if (pc.usingBundle) {\n            break;\n          }\n        }\n      } else {\n        var sdpMLineIndex = candidate.sdpMLineIndex;\n\n        if (candidate.sdpMid) {\n          for (var i = 0; i < pc.transceivers.length; i++) {\n            if (pc.transceivers[i].mid === candidate.sdpMid) {\n              sdpMLineIndex = i;\n              break;\n            }\n          }\n        }\n\n        var transceiver = pc.transceivers[sdpMLineIndex];\n\n        if (transceiver) {\n          if (transceiver.rejected) {\n            return resolve();\n          }\n\n          var cand = Object.keys(candidate.candidate).length > 0 ? SDPUtils.parseCandidate(candidate.candidate) : {}; // Ignore Chrome's invalid candidates since Edge does not like them.\n\n          if (cand.protocol === 'tcp' && (cand.port === 0 || cand.port === 9)) {\n            return resolve();\n          } // Ignore RTCP candidates, we assume RTCP-MUX.\n\n\n          if (cand.component && cand.component !== 1) {\n            return resolve();\n          } // when using bundle, avoid adding candidates to the wrong\n          // ice transport. And avoid adding candidates added in the SDP.\n\n\n          if (sdpMLineIndex === 0 || sdpMLineIndex > 0 && transceiver.iceTransport !== pc.transceivers[0].iceTransport) {\n            if (!maybeAddCandidate(transceiver.iceTransport, cand)) {\n              return reject(makeError('OperationError', 'Can not add ICE candidate'));\n            }\n          } // update the remoteDescription.\n\n\n          var candidateString = candidate.candidate.trim();\n\n          if (candidateString.indexOf('a=') === 0) {\n            candidateString = candidateString.substr(2);\n          }\n\n          sections = SDPUtils.getMediaSections(pc._remoteDescription.sdp);\n          sections[sdpMLineIndex] += 'a=' + (cand.type ? candidateString : 'end-of-candidates') + '\\r\\n';\n          pc._remoteDescription.sdp = SDPUtils.getDescription(pc._remoteDescription.sdp) + sections.join('');\n        } else {\n          return reject(makeError('OperationError', 'Can not add ICE candidate'));\n        }\n      }\n\n      resolve();\n    });\n  };\n\n  RTCPeerConnection.prototype.getStats = function (selector) {\n    if (selector && selector instanceof window.MediaStreamTrack) {\n      var senderOrReceiver = null;\n      this.transceivers.forEach(function (transceiver) {\n        if (transceiver.rtpSender && transceiver.rtpSender.track === selector) {\n          senderOrReceiver = transceiver.rtpSender;\n        } else if (transceiver.rtpReceiver && transceiver.rtpReceiver.track === selector) {\n          senderOrReceiver = transceiver.rtpReceiver;\n        }\n      });\n\n      if (!senderOrReceiver) {\n        throw makeError('InvalidAccessError', 'Invalid selector.');\n      }\n\n      return senderOrReceiver.getStats();\n    }\n\n    var promises = [];\n    this.transceivers.forEach(function (transceiver) {\n      ['rtpSender', 'rtpReceiver', 'iceGatherer', 'iceTransport', 'dtlsTransport'].forEach(function (method) {\n        if (transceiver[method]) {\n          promises.push(transceiver[method].getStats());\n        }\n      });\n    });\n    return Promise.all(promises).then(function (allStats) {\n      var results = new Map();\n      allStats.forEach(function (stats) {\n        stats.forEach(function (stat) {\n          results.set(stat.id, stat);\n        });\n      });\n      return results;\n    });\n  }; // fix low-level stat names and return Map instead of object.\n\n\n  var ortcObjects = ['RTCRtpSender', 'RTCRtpReceiver', 'RTCIceGatherer', 'RTCIceTransport', 'RTCDtlsTransport'];\n  ortcObjects.forEach(function (ortcObjectName) {\n    var obj = window[ortcObjectName];\n\n    if (obj && obj.prototype && obj.prototype.getStats) {\n      var nativeGetstats = obj.prototype.getStats;\n\n      obj.prototype.getStats = function () {\n        return nativeGetstats.apply(this).then(function (nativeStats) {\n          var mapStats = new Map();\n          Object.keys(nativeStats).forEach(function (id) {\n            nativeStats[id].type = fixStatsType(nativeStats[id]);\n            mapStats.set(id, nativeStats[id]);\n          });\n          return mapStats;\n        });\n      };\n    }\n  }); // legacy callback shims. Should be moved to adapter.js some days.\n\n  var methods = ['createOffer', 'createAnswer'];\n  methods.forEach(function (method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n\n    RTCPeerConnection.prototype[method] = function () {\n      var args = arguments;\n\n      if (typeof args[0] === 'function' || typeof args[1] === 'function') {\n        // legacy\n        return nativeMethod.apply(this, [arguments[2]]).then(function (description) {\n          if (typeof args[0] === 'function') {\n            args[0].apply(null, [description]);\n          }\n        }, function (error) {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null, [error]);\n          }\n        });\n      }\n\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n  methods = ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'];\n  methods.forEach(function (method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n\n    RTCPeerConnection.prototype[method] = function () {\n      var args = arguments;\n\n      if (typeof args[1] === 'function' || typeof args[2] === 'function') {\n        // legacy\n        return nativeMethod.apply(this, arguments).then(function () {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        }, function (error) {\n          if (typeof args[2] === 'function') {\n            args[2].apply(null, [error]);\n          }\n        });\n      }\n\n      return nativeMethod.apply(this, arguments);\n    };\n  }); // getStats is special. It doesn't have a spec legacy method yet we support\n  // getStats(something, cb) without error callbacks.\n\n  ['getStats'].forEach(function (method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n\n    RTCPeerConnection.prototype[method] = function () {\n      var args = arguments;\n\n      if (typeof args[1] === 'function') {\n        return nativeMethod.apply(this, arguments).then(function () {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        });\n      }\n\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n  return RTCPeerConnection;\n};","map":{"version":3,"sources":["/Users/sam/Desktop/kiwik/node_modules/rtcpeerconnection-shim/rtcpeerconnection.js"],"names":["SDPUtils","require","fixStatsType","stat","inboundrtp","outboundrtp","candidatepair","localcandidate","remotecandidate","type","writeMediaSection","transceiver","caps","stream","dtlsRole","sdp","writeRtpDescription","kind","writeIceParameters","iceGatherer","getLocalParameters","writeDtlsParameters","dtlsTransport","mid","rtpSender","rtpReceiver","trackId","_initialTrackId","track","id","msid","sendEncodingParameters","ssrc","rtx","localCName","filterIceServers","iceServers","edgeVersion","hasTurn","JSON","parse","stringify","filter","server","urls","url","console","warn","isString","validTurn","indexOf","length","getCommonCapabilities","localCapabilities","remoteCapabilities","commonCapabilities","codecs","headerExtensions","fecMechanisms","findCodecByPayloadType","pt","parseInt","i","payloadType","preferredPayloadType","rtxCapabilityMatches","lRtx","rRtx","lCodecs","rCodecs","lCodec","parameters","apt","rCodec","name","toLowerCase","forEach","clockRate","numChannels","Math","min","push","rtcpFeedback","fb","j","parameter","lHeaderExtension","rHeaderExtension","uri","isActionAllowedInSignalingState","action","signalingState","offer","setLocalDescription","setRemoteDescription","answer","maybeAddCandidate","iceTransport","candidate","alreadyAdded","getRemoteCandidates","find","remoteCandidate","foundation","ip","port","priority","protocol","addRemoteCandidate","makeError","description","e","Error","code","NotSupportedError","InvalidStateError","InvalidAccessError","TypeError","undefined","OperationError","module","exports","window","addTrackToStreamAndFireEvent","addTrack","dispatchEvent","MediaStreamTrackEvent","removeTrackFromStreamAndFireEvent","removeTrack","fireAddTrack","pc","receiver","streams","trackEvent","Event","setTimeout","_dispatchEvent","RTCPeerConnection","config","_eventTarget","document","createDocumentFragment","method","bind","canTrickleIceCandidates","needNegotiation","localStreams","remoteStreams","_localDescription","_remoteDescription","iceConnectionState","connectionState","iceGatheringState","usingBundle","bundlePolicy","rtcpMuxPolicy","iceTransportPolicy","_iceGatherers","iceCandidatePoolSize","RTCIceGatherer","gatherPolicy","_config","transceivers","_sdpSessionId","generateSessionId","_sdpSessionVersion","_dtlsRole","_isClosed","Object","defineProperty","prototype","configurable","get","onicecandidate","onaddstream","ontrack","onremovestream","onsignalingstatechange","oniceconnectionstatechange","onconnectionstatechange","onicegatheringstatechange","onnegotiationneeded","ondatachannel","event","_emitGatheringStateChange","getConfiguration","getLocalStreams","getRemoteStreams","_createTransceiver","doNotAdd","hasBundleTransport","recvEncodingParameters","associatedRemoteMediaStreams","wantReceive","transports","_createIceAndDtlsTransports","alreadyExists","s","_maybeFireNegotiationNeeded","RTCRtpSender","addStream","getTracks","clonedStream","clone","idx","clonedTrack","addEventListener","enabled","sender","t","stop","map","splice","removeStream","getSenders","getReceivers","_createIceGatherer","sdpMLineIndex","shift","value","writable","bufferedCandidateEvents","bufferCandidates","end","keys","state","_gather","onlocalcandidate","removeEventListener","evt","sdpMid","cand","component","ufrag","usernameFragment","serializedCandidate","writeCandidate","assign","parseCandidate","toJSON","sections","getMediaSections","getDescription","join","complete","every","RTCIceTransport","onicestatechange","_updateIceConnectionState","_updateConnectionState","RTCDtlsTransport","ondtlsstatechange","onerror","_disposeIceAndDtlsTransports","_transceive","send","recv","params","encodings","rtcp","cname","compound","rtcpParameters","p","receive","Promise","reject","sessionpart","splitSections","mediaSection","parseRtpParameters","isIceLite","matchPrefix","rejected","isRejected","remoteIceParameters","getIceParameters","remoteDtlsParameters","getDtlsParameters","role","start","_updateSignalingState","resolve","receiverList","iceOptions","substr","split","lines","splitLines","getKind","direction","getDirection","remoteMsid","parseMsid","getMid","generateIdentifier","parseRtpEncodingParameters","parseRtcpParameters","isComplete","cands","setTransport","setRemoteCandidates","RTCRtpReceiver","getCapabilities","codec","isNewTrack","MediaStream","default","nativeTrack","hasRtx","c","sid","item","close","newState","states","closed","checking","connected","completed","disconnected","failed","new","connecting","createOffer","numAudioTracks","numVideoTracks","offerOptions","arguments","mandatory","optional","offerToReceiveAudio","offerToReceiveVideo","writeSessionBoilerplate","remoteCodec","hdrExt","remoteExtensions","rHdrExt","getLocalCandidates","desc","RTCSessionDescription","createAnswer","mediaSectionsInOffer","localTrack","getAudioTracks","getVideoTracks","reducedSize","addIceCandidate","candidateString","trim","getStats","selector","MediaStreamTrack","senderOrReceiver","promises","all","then","allStats","results","Map","stats","set","ortcObjects","ortcObjectName","obj","nativeGetstats","apply","nativeStats","mapStats","methods","nativeMethod","args","error"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2017 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\nvar SDPUtils = require('sdp');\n\nfunction fixStatsType(stat) {\n  return {\n    inboundrtp: 'inbound-rtp',\n    outboundrtp: 'outbound-rtp',\n    candidatepair: 'candidate-pair',\n    localcandidate: 'local-candidate',\n    remotecandidate: 'remote-candidate'\n  }[stat.type] || stat.type;\n}\n\nfunction writeMediaSection(transceiver, caps, type, stream, dtlsRole) {\n  var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps);\n\n  // Map ICE parameters (ufrag, pwd) to SDP.\n  sdp += SDPUtils.writeIceParameters(\n      transceiver.iceGatherer.getLocalParameters());\n\n  // Map DTLS parameters to SDP.\n  sdp += SDPUtils.writeDtlsParameters(\n      transceiver.dtlsTransport.getLocalParameters(),\n      type === 'offer' ? 'actpass' : dtlsRole || 'active');\n\n  sdp += 'a=mid:' + transceiver.mid + '\\r\\n';\n\n  if (transceiver.rtpSender && transceiver.rtpReceiver) {\n    sdp += 'a=sendrecv\\r\\n';\n  } else if (transceiver.rtpSender) {\n    sdp += 'a=sendonly\\r\\n';\n  } else if (transceiver.rtpReceiver) {\n    sdp += 'a=recvonly\\r\\n';\n  } else {\n    sdp += 'a=inactive\\r\\n';\n  }\n\n  if (transceiver.rtpSender) {\n    var trackId = transceiver.rtpSender._initialTrackId ||\n        transceiver.rtpSender.track.id;\n    transceiver.rtpSender._initialTrackId = trackId;\n    // spec.\n    var msid = 'msid:' + (stream ? stream.id : '-') + ' ' +\n        trackId + '\\r\\n';\n    sdp += 'a=' + msid;\n    // for Chrome. Legacy should no longer be required.\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +\n        ' ' + msid;\n\n    // RTX\n    if (transceiver.sendEncodingParameters[0].rtx) {\n      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +\n          ' ' + msid;\n      sdp += 'a=ssrc-group:FID ' +\n          transceiver.sendEncodingParameters[0].ssrc + ' ' +\n          transceiver.sendEncodingParameters[0].rtx.ssrc +\n          '\\r\\n';\n    }\n  }\n  // FIXME: this should be written by writeRtpDescription.\n  sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +\n      ' cname:' + SDPUtils.localCName + '\\r\\n';\n  if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +\n        ' cname:' + SDPUtils.localCName + '\\r\\n';\n  }\n  return sdp;\n}\n\n// Edge does not like\n// 1) stun: filtered after 14393 unless ?transport=udp is present\n// 2) turn: that does not have all of turn:host:port?transport=udp\n// 3) turn: with ipv6 addresses\n// 4) turn: occurring muliple times\nfunction filterIceServers(iceServers, edgeVersion) {\n  var hasTurn = false;\n  iceServers = JSON.parse(JSON.stringify(iceServers));\n  return iceServers.filter(function(server) {\n    if (server && (server.urls || server.url)) {\n      var urls = server.urls || server.url;\n      if (server.url && !server.urls) {\n        console.warn('RTCIceServer.url is deprecated! Use urls instead.');\n      }\n      var isString = typeof urls === 'string';\n      if (isString) {\n        urls = [urls];\n      }\n      urls = urls.filter(function(url) {\n        var validTurn = url.indexOf('turn:') === 0 &&\n            url.indexOf('transport=udp') !== -1 &&\n            url.indexOf('turn:[') === -1 &&\n            !hasTurn;\n\n        if (validTurn) {\n          hasTurn = true;\n          return true;\n        }\n        return url.indexOf('stun:') === 0 && edgeVersion >= 14393 &&\n            url.indexOf('?transport=udp') === -1;\n      });\n\n      delete server.url;\n      server.urls = isString ? urls[0] : urls;\n      return !!urls.length;\n    }\n  });\n}\n\n// Determines the intersection of local and remote capabilities.\nfunction getCommonCapabilities(localCapabilities, remoteCapabilities) {\n  var commonCapabilities = {\n    codecs: [],\n    headerExtensions: [],\n    fecMechanisms: []\n  };\n\n  var findCodecByPayloadType = function(pt, codecs) {\n    pt = parseInt(pt, 10);\n    for (var i = 0; i < codecs.length; i++) {\n      if (codecs[i].payloadType === pt ||\n          codecs[i].preferredPayloadType === pt) {\n        return codecs[i];\n      }\n    }\n  };\n\n  var rtxCapabilityMatches = function(lRtx, rRtx, lCodecs, rCodecs) {\n    var lCodec = findCodecByPayloadType(lRtx.parameters.apt, lCodecs);\n    var rCodec = findCodecByPayloadType(rRtx.parameters.apt, rCodecs);\n    return lCodec && rCodec &&\n        lCodec.name.toLowerCase() === rCodec.name.toLowerCase();\n  };\n\n  localCapabilities.codecs.forEach(function(lCodec) {\n    for (var i = 0; i < remoteCapabilities.codecs.length; i++) {\n      var rCodec = remoteCapabilities.codecs[i];\n      if (lCodec.name.toLowerCase() === rCodec.name.toLowerCase() &&\n          lCodec.clockRate === rCodec.clockRate) {\n        if (lCodec.name.toLowerCase() === 'rtx' &&\n            lCodec.parameters && rCodec.parameters.apt) {\n          // for RTX we need to find the local rtx that has a apt\n          // which points to the same local codec as the remote one.\n          if (!rtxCapabilityMatches(lCodec, rCodec,\n              localCapabilities.codecs, remoteCapabilities.codecs)) {\n            continue;\n          }\n        }\n        rCodec = JSON.parse(JSON.stringify(rCodec)); // deepcopy\n        // number of channels is the highest common number of channels\n        rCodec.numChannels = Math.min(lCodec.numChannels,\n            rCodec.numChannels);\n        // push rCodec so we reply with offerer payload type\n        commonCapabilities.codecs.push(rCodec);\n\n        // determine common feedback mechanisms\n        rCodec.rtcpFeedback = rCodec.rtcpFeedback.filter(function(fb) {\n          for (var j = 0; j < lCodec.rtcpFeedback.length; j++) {\n            if (lCodec.rtcpFeedback[j].type === fb.type &&\n                lCodec.rtcpFeedback[j].parameter === fb.parameter) {\n              return true;\n            }\n          }\n          return false;\n        });\n        // FIXME: also need to determine .parameters\n        //  see https://github.com/openpeer/ortc/issues/569\n        break;\n      }\n    }\n  });\n\n  localCapabilities.headerExtensions.forEach(function(lHeaderExtension) {\n    for (var i = 0; i < remoteCapabilities.headerExtensions.length;\n         i++) {\n      var rHeaderExtension = remoteCapabilities.headerExtensions[i];\n      if (lHeaderExtension.uri === rHeaderExtension.uri) {\n        commonCapabilities.headerExtensions.push(rHeaderExtension);\n        break;\n      }\n    }\n  });\n\n  // FIXME: fecMechanisms\n  return commonCapabilities;\n}\n\n// is action=setLocalDescription with type allowed in signalingState\nfunction isActionAllowedInSignalingState(action, type, signalingState) {\n  return {\n    offer: {\n      setLocalDescription: ['stable', 'have-local-offer'],\n      setRemoteDescription: ['stable', 'have-remote-offer']\n    },\n    answer: {\n      setLocalDescription: ['have-remote-offer', 'have-local-pranswer'],\n      setRemoteDescription: ['have-local-offer', 'have-remote-pranswer']\n    }\n  }[type][action].indexOf(signalingState) !== -1;\n}\n\nfunction maybeAddCandidate(iceTransport, candidate) {\n  // Edge's internal representation adds some fields therefore\n  // not all fieldÑ• are taken into account.\n  var alreadyAdded = iceTransport.getRemoteCandidates()\n      .find(function(remoteCandidate) {\n        return candidate.foundation === remoteCandidate.foundation &&\n            candidate.ip === remoteCandidate.ip &&\n            candidate.port === remoteCandidate.port &&\n            candidate.priority === remoteCandidate.priority &&\n            candidate.protocol === remoteCandidate.protocol &&\n            candidate.type === remoteCandidate.type;\n      });\n  if (!alreadyAdded) {\n    iceTransport.addRemoteCandidate(candidate);\n  }\n  return !alreadyAdded;\n}\n\n\nfunction makeError(name, description) {\n  var e = new Error(description);\n  e.name = name;\n  // legacy error codes from https://heycam.github.io/webidl/#idl-DOMException-error-names\n  e.code = {\n    NotSupportedError: 9,\n    InvalidStateError: 11,\n    InvalidAccessError: 15,\n    TypeError: undefined,\n    OperationError: undefined\n  }[name];\n  return e;\n}\n\nmodule.exports = function(window, edgeVersion) {\n  // https://w3c.github.io/mediacapture-main/#mediastream\n  // Helper function to add the track to the stream and\n  // dispatch the event ourselves.\n  function addTrackToStreamAndFireEvent(track, stream) {\n    stream.addTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('addtrack',\n        {track: track}));\n  }\n\n  function removeTrackFromStreamAndFireEvent(track, stream) {\n    stream.removeTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('removetrack',\n        {track: track}));\n  }\n\n  function fireAddTrack(pc, track, receiver, streams) {\n    var trackEvent = new Event('track');\n    trackEvent.track = track;\n    trackEvent.receiver = receiver;\n    trackEvent.transceiver = {receiver: receiver};\n    trackEvent.streams = streams;\n    window.setTimeout(function() {\n      pc._dispatchEvent('track', trackEvent);\n    });\n  }\n\n  var RTCPeerConnection = function(config) {\n    var pc = this;\n\n    var _eventTarget = document.createDocumentFragment();\n    ['addEventListener', 'removeEventListener', 'dispatchEvent']\n        .forEach(function(method) {\n          pc[method] = _eventTarget[method].bind(_eventTarget);\n        });\n\n    this.canTrickleIceCandidates = null;\n\n    this.needNegotiation = false;\n\n    this.localStreams = [];\n    this.remoteStreams = [];\n\n    this._localDescription = null;\n    this._remoteDescription = null;\n\n    this.signalingState = 'stable';\n    this.iceConnectionState = 'new';\n    this.connectionState = 'new';\n    this.iceGatheringState = 'new';\n\n    config = JSON.parse(JSON.stringify(config || {}));\n\n    this.usingBundle = config.bundlePolicy === 'max-bundle';\n    if (config.rtcpMuxPolicy === 'negotiate') {\n      throw(makeError('NotSupportedError',\n          'rtcpMuxPolicy \\'negotiate\\' is not supported'));\n    } else if (!config.rtcpMuxPolicy) {\n      config.rtcpMuxPolicy = 'require';\n    }\n\n    switch (config.iceTransportPolicy) {\n      case 'all':\n      case 'relay':\n        break;\n      default:\n        config.iceTransportPolicy = 'all';\n        break;\n    }\n\n    switch (config.bundlePolicy) {\n      case 'balanced':\n      case 'max-compat':\n      case 'max-bundle':\n        break;\n      default:\n        config.bundlePolicy = 'balanced';\n        break;\n    }\n\n    config.iceServers = filterIceServers(config.iceServers || [], edgeVersion);\n\n    this._iceGatherers = [];\n    if (config.iceCandidatePoolSize) {\n      for (var i = config.iceCandidatePoolSize; i > 0; i--) {\n        this._iceGatherers.push(new window.RTCIceGatherer({\n          iceServers: config.iceServers,\n          gatherPolicy: config.iceTransportPolicy\n        }));\n      }\n    } else {\n      config.iceCandidatePoolSize = 0;\n    }\n\n    this._config = config;\n\n    // per-track iceGathers, iceTransports, dtlsTransports, rtpSenders, ...\n    // everything that is needed to describe a SDP m-line.\n    this.transceivers = [];\n\n    this._sdpSessionId = SDPUtils.generateSessionId();\n    this._sdpSessionVersion = 0;\n\n    this._dtlsRole = undefined; // role for a=setup to use in answers.\n\n    this._isClosed = false;\n  };\n\n  Object.defineProperty(RTCPeerConnection.prototype, 'localDescription', {\n    configurable: true,\n    get: function() {\n      return this._localDescription;\n    }\n  });\n  Object.defineProperty(RTCPeerConnection.prototype, 'remoteDescription', {\n    configurable: true,\n    get: function() {\n      return this._remoteDescription;\n    }\n  });\n\n  // set up event handlers on prototype\n  RTCPeerConnection.prototype.onicecandidate = null;\n  RTCPeerConnection.prototype.onaddstream = null;\n  RTCPeerConnection.prototype.ontrack = null;\n  RTCPeerConnection.prototype.onremovestream = null;\n  RTCPeerConnection.prototype.onsignalingstatechange = null;\n  RTCPeerConnection.prototype.oniceconnectionstatechange = null;\n  RTCPeerConnection.prototype.onconnectionstatechange = null;\n  RTCPeerConnection.prototype.onicegatheringstatechange = null;\n  RTCPeerConnection.prototype.onnegotiationneeded = null;\n  RTCPeerConnection.prototype.ondatachannel = null;\n\n  RTCPeerConnection.prototype._dispatchEvent = function(name, event) {\n    if (this._isClosed) {\n      return;\n    }\n    this.dispatchEvent(event);\n    if (typeof this['on' + name] === 'function') {\n      this['on' + name](event);\n    }\n  };\n\n  RTCPeerConnection.prototype._emitGatheringStateChange = function() {\n    var event = new Event('icegatheringstatechange');\n    this._dispatchEvent('icegatheringstatechange', event);\n  };\n\n  RTCPeerConnection.prototype.getConfiguration = function() {\n    return this._config;\n  };\n\n  RTCPeerConnection.prototype.getLocalStreams = function() {\n    return this.localStreams;\n  };\n\n  RTCPeerConnection.prototype.getRemoteStreams = function() {\n    return this.remoteStreams;\n  };\n\n  // internal helper to create a transceiver object.\n  // (which is not yet the same as the WebRTC 1.0 transceiver)\n  RTCPeerConnection.prototype._createTransceiver = function(kind, doNotAdd) {\n    var hasBundleTransport = this.transceivers.length > 0;\n    var transceiver = {\n      track: null,\n      iceGatherer: null,\n      iceTransport: null,\n      dtlsTransport: null,\n      localCapabilities: null,\n      remoteCapabilities: null,\n      rtpSender: null,\n      rtpReceiver: null,\n      kind: kind,\n      mid: null,\n      sendEncodingParameters: null,\n      recvEncodingParameters: null,\n      stream: null,\n      associatedRemoteMediaStreams: [],\n      wantReceive: true\n    };\n    if (this.usingBundle && hasBundleTransport) {\n      transceiver.iceTransport = this.transceivers[0].iceTransport;\n      transceiver.dtlsTransport = this.transceivers[0].dtlsTransport;\n    } else {\n      var transports = this._createIceAndDtlsTransports();\n      transceiver.iceTransport = transports.iceTransport;\n      transceiver.dtlsTransport = transports.dtlsTransport;\n    }\n    if (!doNotAdd) {\n      this.transceivers.push(transceiver);\n    }\n    return transceiver;\n  };\n\n  RTCPeerConnection.prototype.addTrack = function(track, stream) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError',\n          'Attempted to call addTrack on a closed peerconnection.');\n    }\n\n    var alreadyExists = this.transceivers.find(function(s) {\n      return s.track === track;\n    });\n\n    if (alreadyExists) {\n      throw makeError('InvalidAccessError', 'Track already exists.');\n    }\n\n    var transceiver;\n    for (var i = 0; i < this.transceivers.length; i++) {\n      if (!this.transceivers[i].track &&\n          this.transceivers[i].kind === track.kind) {\n        transceiver = this.transceivers[i];\n      }\n    }\n    if (!transceiver) {\n      transceiver = this._createTransceiver(track.kind);\n    }\n\n    this._maybeFireNegotiationNeeded();\n\n    if (this.localStreams.indexOf(stream) === -1) {\n      this.localStreams.push(stream);\n    }\n\n    transceiver.track = track;\n    transceiver.stream = stream;\n    transceiver.rtpSender = new window.RTCRtpSender(track,\n        transceiver.dtlsTransport);\n    return transceiver.rtpSender;\n  };\n\n  RTCPeerConnection.prototype.addStream = function(stream) {\n    var pc = this;\n    if (edgeVersion >= 15025) {\n      stream.getTracks().forEach(function(track) {\n        pc.addTrack(track, stream);\n      });\n    } else {\n      // Clone is necessary for local demos mostly, attaching directly\n      // to two different senders does not work (build 10547).\n      // Fixed in 15025 (or earlier)\n      var clonedStream = stream.clone();\n      stream.getTracks().forEach(function(track, idx) {\n        var clonedTrack = clonedStream.getTracks()[idx];\n        track.addEventListener('enabled', function(event) {\n          clonedTrack.enabled = event.enabled;\n        });\n      });\n      clonedStream.getTracks().forEach(function(track) {\n        pc.addTrack(track, clonedStream);\n      });\n    }\n  };\n\n  RTCPeerConnection.prototype.removeTrack = function(sender) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError',\n          'Attempted to call removeTrack on a closed peerconnection.');\n    }\n\n    if (!(sender instanceof window.RTCRtpSender)) {\n      throw new TypeError('Argument 1 of RTCPeerConnection.removeTrack ' +\n          'does not implement interface RTCRtpSender.');\n    }\n\n    var transceiver = this.transceivers.find(function(t) {\n      return t.rtpSender === sender;\n    });\n\n    if (!transceiver) {\n      throw makeError('InvalidAccessError',\n          'Sender was not created by this connection.');\n    }\n    var stream = transceiver.stream;\n\n    transceiver.rtpSender.stop();\n    transceiver.rtpSender = null;\n    transceiver.track = null;\n    transceiver.stream = null;\n\n    // remove the stream from the set of local streams\n    var localStreams = this.transceivers.map(function(t) {\n      return t.stream;\n    });\n    if (localStreams.indexOf(stream) === -1 &&\n        this.localStreams.indexOf(stream) > -1) {\n      this.localStreams.splice(this.localStreams.indexOf(stream), 1);\n    }\n\n    this._maybeFireNegotiationNeeded();\n  };\n\n  RTCPeerConnection.prototype.removeStream = function(stream) {\n    var pc = this;\n    stream.getTracks().forEach(function(track) {\n      var sender = pc.getSenders().find(function(s) {\n        return s.track === track;\n      });\n      if (sender) {\n        pc.removeTrack(sender);\n      }\n    });\n  };\n\n  RTCPeerConnection.prototype.getSenders = function() {\n    return this.transceivers.filter(function(transceiver) {\n      return !!transceiver.rtpSender;\n    })\n    .map(function(transceiver) {\n      return transceiver.rtpSender;\n    });\n  };\n\n  RTCPeerConnection.prototype.getReceivers = function() {\n    return this.transceivers.filter(function(transceiver) {\n      return !!transceiver.rtpReceiver;\n    })\n    .map(function(transceiver) {\n      return transceiver.rtpReceiver;\n    });\n  };\n\n\n  RTCPeerConnection.prototype._createIceGatherer = function(sdpMLineIndex,\n      usingBundle) {\n    var pc = this;\n    if (usingBundle && sdpMLineIndex > 0) {\n      return this.transceivers[0].iceGatherer;\n    } else if (this._iceGatherers.length) {\n      return this._iceGatherers.shift();\n    }\n    var iceGatherer = new window.RTCIceGatherer({\n      iceServers: this._config.iceServers,\n      gatherPolicy: this._config.iceTransportPolicy\n    });\n    Object.defineProperty(iceGatherer, 'state',\n        {value: 'new', writable: true}\n    );\n\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = [];\n    this.transceivers[sdpMLineIndex].bufferCandidates = function(event) {\n      var end = !event.candidate || Object.keys(event.candidate).length === 0;\n      // polyfill since RTCIceGatherer.state is not implemented in\n      // Edge 10547 yet.\n      iceGatherer.state = end ? 'completed' : 'gathering';\n      if (pc.transceivers[sdpMLineIndex].bufferedCandidateEvents !== null) {\n        pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event);\n      }\n    };\n    iceGatherer.addEventListener('localcandidate',\n      this.transceivers[sdpMLineIndex].bufferCandidates);\n    return iceGatherer;\n  };\n\n  // start gathering from an RTCIceGatherer.\n  RTCPeerConnection.prototype._gather = function(mid, sdpMLineIndex) {\n    var pc = this;\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n    if (iceGatherer.onlocalcandidate) {\n      return;\n    }\n    var bufferedCandidateEvents =\n      this.transceivers[sdpMLineIndex].bufferedCandidateEvents;\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = null;\n    iceGatherer.removeEventListener('localcandidate',\n      this.transceivers[sdpMLineIndex].bufferCandidates);\n    iceGatherer.onlocalcandidate = function(evt) {\n      if (pc.usingBundle && sdpMLineIndex > 0) {\n        // if we know that we use bundle we can drop candidates with\n        // Ñ•dpMLineIndex > 0. If we don't do this then our state gets\n        // confused since we dispose the extra ice gatherer.\n        return;\n      }\n      var event = new Event('icecandidate');\n      event.candidate = {sdpMid: mid, sdpMLineIndex: sdpMLineIndex};\n\n      var cand = evt.candidate;\n      // Edge emits an empty object for RTCIceCandidateCompleteâ€¥\n      var end = !cand || Object.keys(cand).length === 0;\n      if (end) {\n        // polyfill since RTCIceGatherer.state is not implemented in\n        // Edge 10547 yet.\n        if (iceGatherer.state === 'new' || iceGatherer.state === 'gathering') {\n          iceGatherer.state = 'completed';\n        }\n      } else {\n        if (iceGatherer.state === 'new') {\n          iceGatherer.state = 'gathering';\n        }\n        // RTCIceCandidate doesn't have a component, needs to be added\n        cand.component = 1;\n        // also the usernameFragment. TODO: update SDP to take both variants.\n        cand.ufrag = iceGatherer.getLocalParameters().usernameFragment;\n\n        var serializedCandidate = SDPUtils.writeCandidate(cand);\n        event.candidate = Object.assign(event.candidate,\n            SDPUtils.parseCandidate(serializedCandidate));\n\n        event.candidate.candidate = serializedCandidate;\n        event.candidate.toJSON = function() {\n          return {\n            candidate: event.candidate.candidate,\n            sdpMid: event.candidate.sdpMid,\n            sdpMLineIndex: event.candidate.sdpMLineIndex,\n            usernameFragment: event.candidate.usernameFragment\n          };\n        };\n      }\n\n      // update local description.\n      var sections = SDPUtils.getMediaSections(pc._localDescription.sdp);\n      if (!end) {\n        sections[event.candidate.sdpMLineIndex] +=\n            'a=' + event.candidate.candidate + '\\r\\n';\n      } else {\n        sections[event.candidate.sdpMLineIndex] +=\n            'a=end-of-candidates\\r\\n';\n      }\n      pc._localDescription.sdp =\n          SDPUtils.getDescription(pc._localDescription.sdp) +\n          sections.join('');\n      var complete = pc.transceivers.every(function(transceiver) {\n        return transceiver.iceGatherer &&\n            transceiver.iceGatherer.state === 'completed';\n      });\n\n      if (pc.iceGatheringState !== 'gathering') {\n        pc.iceGatheringState = 'gathering';\n        pc._emitGatheringStateChange();\n      }\n\n      // Emit candidate. Also emit null candidate when all gatherers are\n      // complete.\n      if (!end) {\n        pc._dispatchEvent('icecandidate', event);\n      }\n      if (complete) {\n        pc._dispatchEvent('icecandidate', new Event('icecandidate'));\n        pc.iceGatheringState = 'complete';\n        pc._emitGatheringStateChange();\n      }\n    };\n\n    // emit already gathered candidates.\n    window.setTimeout(function() {\n      bufferedCandidateEvents.forEach(function(e) {\n        iceGatherer.onlocalcandidate(e);\n      });\n    }, 0);\n  };\n\n  // Create ICE transport and DTLS transport.\n  RTCPeerConnection.prototype._createIceAndDtlsTransports = function() {\n    var pc = this;\n    var iceTransport = new window.RTCIceTransport(null);\n    iceTransport.onicestatechange = function() {\n      pc._updateIceConnectionState();\n      pc._updateConnectionState();\n    };\n\n    var dtlsTransport = new window.RTCDtlsTransport(iceTransport);\n    dtlsTransport.ondtlsstatechange = function() {\n      pc._updateConnectionState();\n    };\n    dtlsTransport.onerror = function() {\n      // onerror does not set state to failed by itself.\n      Object.defineProperty(dtlsTransport, 'state',\n          {value: 'failed', writable: true});\n      pc._updateConnectionState();\n    };\n\n    return {\n      iceTransport: iceTransport,\n      dtlsTransport: dtlsTransport\n    };\n  };\n\n  // Destroy ICE gatherer, ICE transport and DTLS transport.\n  // Without triggering the callbacks.\n  RTCPeerConnection.prototype._disposeIceAndDtlsTransports = function(\n      sdpMLineIndex) {\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n    if (iceGatherer) {\n      delete iceGatherer.onlocalcandidate;\n      delete this.transceivers[sdpMLineIndex].iceGatherer;\n    }\n    var iceTransport = this.transceivers[sdpMLineIndex].iceTransport;\n    if (iceTransport) {\n      delete iceTransport.onicestatechange;\n      delete this.transceivers[sdpMLineIndex].iceTransport;\n    }\n    var dtlsTransport = this.transceivers[sdpMLineIndex].dtlsTransport;\n    if (dtlsTransport) {\n      delete dtlsTransport.ondtlsstatechange;\n      delete dtlsTransport.onerror;\n      delete this.transceivers[sdpMLineIndex].dtlsTransport;\n    }\n  };\n\n  // Start the RTP Sender and Receiver for a transceiver.\n  RTCPeerConnection.prototype._transceive = function(transceiver,\n      send, recv) {\n    var params = getCommonCapabilities(transceiver.localCapabilities,\n        transceiver.remoteCapabilities);\n    if (send && transceiver.rtpSender) {\n      params.encodings = transceiver.sendEncodingParameters;\n      params.rtcp = {\n        cname: SDPUtils.localCName,\n        compound: transceiver.rtcpParameters.compound\n      };\n      if (transceiver.recvEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.recvEncodingParameters[0].ssrc;\n      }\n      transceiver.rtpSender.send(params);\n    }\n    if (recv && transceiver.rtpReceiver && params.codecs.length > 0) {\n      // remove RTX field in Edge 14942\n      if (transceiver.kind === 'video'\n          && transceiver.recvEncodingParameters\n          && edgeVersion < 15019) {\n        transceiver.recvEncodingParameters.forEach(function(p) {\n          delete p.rtx;\n        });\n      }\n      if (transceiver.recvEncodingParameters.length) {\n        params.encodings = transceiver.recvEncodingParameters;\n      } else {\n        params.encodings = [{}];\n      }\n      params.rtcp = {\n        compound: transceiver.rtcpParameters.compound\n      };\n      if (transceiver.rtcpParameters.cname) {\n        params.rtcp.cname = transceiver.rtcpParameters.cname;\n      }\n      if (transceiver.sendEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.sendEncodingParameters[0].ssrc;\n      }\n      transceiver.rtpReceiver.receive(params);\n    }\n  };\n\n  RTCPeerConnection.prototype.setLocalDescription = function(description) {\n    var pc = this;\n\n    // Note: pranswer is not supported.\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError',\n          'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setLocalDescription',\n        description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not set local ' + description.type +\n          ' in state ' + pc.signalingState));\n    }\n\n    var sections;\n    var sessionpart;\n    if (description.type === 'offer') {\n      // VERY limited support for SDP munging. Limited to:\n      // * changing the order of codecs\n      sections = SDPUtils.splitSections(description.sdp);\n      sessionpart = sections.shift();\n      sections.forEach(function(mediaSection, sdpMLineIndex) {\n        var caps = SDPUtils.parseRtpParameters(mediaSection);\n        pc.transceivers[sdpMLineIndex].localCapabilities = caps;\n      });\n\n      pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n        pc._gather(transceiver.mid, sdpMLineIndex);\n      });\n    } else if (description.type === 'answer') {\n      sections = SDPUtils.splitSections(pc._remoteDescription.sdp);\n      sessionpart = sections.shift();\n      var isIceLite = SDPUtils.matchPrefix(sessionpart,\n          'a=ice-lite').length > 0;\n      sections.forEach(function(mediaSection, sdpMLineIndex) {\n        var transceiver = pc.transceivers[sdpMLineIndex];\n        var iceGatherer = transceiver.iceGatherer;\n        var iceTransport = transceiver.iceTransport;\n        var dtlsTransport = transceiver.dtlsTransport;\n        var localCapabilities = transceiver.localCapabilities;\n        var remoteCapabilities = transceiver.remoteCapabilities;\n\n        // treat bundle-only as not-rejected.\n        var rejected = SDPUtils.isRejected(mediaSection) &&\n            SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n\n        if (!rejected && !transceiver.rejected) {\n          var remoteIceParameters = SDPUtils.getIceParameters(\n              mediaSection, sessionpart);\n          var remoteDtlsParameters = SDPUtils.getDtlsParameters(\n              mediaSection, sessionpart);\n          if (isIceLite) {\n            remoteDtlsParameters.role = 'server';\n          }\n\n          if (!pc.usingBundle || sdpMLineIndex === 0) {\n            pc._gather(transceiver.mid, sdpMLineIndex);\n            if (iceTransport.state === 'new') {\n              iceTransport.start(iceGatherer, remoteIceParameters,\n                  isIceLite ? 'controlling' : 'controlled');\n            }\n            if (dtlsTransport.state === 'new') {\n              dtlsTransport.start(remoteDtlsParameters);\n            }\n          }\n\n          // Calculate intersection of capabilities.\n          var params = getCommonCapabilities(localCapabilities,\n              remoteCapabilities);\n\n          // Start the RTCRtpSender. The RTCRtpReceiver for this\n          // transceiver has already been started in setRemoteDescription.\n          pc._transceive(transceiver,\n              params.codecs.length > 0,\n              false);\n        }\n      });\n    }\n\n    pc._localDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-local-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.setRemoteDescription = function(description) {\n    var pc = this;\n\n    // Note: pranswer is not supported.\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError',\n          'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setRemoteDescription',\n        description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not set remote ' + description.type +\n          ' in state ' + pc.signalingState));\n    }\n\n    var streams = {};\n    pc.remoteStreams.forEach(function(stream) {\n      streams[stream.id] = stream;\n    });\n    var receiverList = [];\n    var sections = SDPUtils.splitSections(description.sdp);\n    var sessionpart = sections.shift();\n    var isIceLite = SDPUtils.matchPrefix(sessionpart,\n        'a=ice-lite').length > 0;\n    var usingBundle = SDPUtils.matchPrefix(sessionpart,\n        'a=group:BUNDLE ').length > 0;\n    pc.usingBundle = usingBundle;\n    var iceOptions = SDPUtils.matchPrefix(sessionpart,\n        'a=ice-options:')[0];\n    if (iceOptions) {\n      pc.canTrickleIceCandidates = iceOptions.substr(14).split(' ')\n          .indexOf('trickle') >= 0;\n    } else {\n      pc.canTrickleIceCandidates = false;\n    }\n\n    sections.forEach(function(mediaSection, sdpMLineIndex) {\n      var lines = SDPUtils.splitLines(mediaSection);\n      var kind = SDPUtils.getKind(mediaSection);\n      // treat bundle-only as not-rejected.\n      var rejected = SDPUtils.isRejected(mediaSection) &&\n          SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n      var protocol = lines[0].substr(2).split(' ')[2];\n\n      var direction = SDPUtils.getDirection(mediaSection, sessionpart);\n      var remoteMsid = SDPUtils.parseMsid(mediaSection);\n\n      var mid = SDPUtils.getMid(mediaSection) || SDPUtils.generateIdentifier();\n\n      // Reject datachannels which are not implemented yet.\n      if (rejected || (kind === 'application' && (protocol === 'DTLS/SCTP' ||\n          protocol === 'UDP/DTLS/SCTP'))) {\n        // TODO: this is dangerous in the case where a non-rejected m-line\n        //     becomes rejected.\n        pc.transceivers[sdpMLineIndex] = {\n          mid: mid,\n          kind: kind,\n          protocol: protocol,\n          rejected: true\n        };\n        return;\n      }\n\n      if (!rejected && pc.transceivers[sdpMLineIndex] &&\n          pc.transceivers[sdpMLineIndex].rejected) {\n        // recycle a rejected transceiver.\n        pc.transceivers[sdpMLineIndex] = pc._createTransceiver(kind, true);\n      }\n\n      var transceiver;\n      var iceGatherer;\n      var iceTransport;\n      var dtlsTransport;\n      var rtpReceiver;\n      var sendEncodingParameters;\n      var recvEncodingParameters;\n      var localCapabilities;\n\n      var track;\n      // FIXME: ensure the mediaSection has rtcp-mux set.\n      var remoteCapabilities = SDPUtils.parseRtpParameters(mediaSection);\n      var remoteIceParameters;\n      var remoteDtlsParameters;\n      if (!rejected) {\n        remoteIceParameters = SDPUtils.getIceParameters(mediaSection,\n            sessionpart);\n        remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection,\n            sessionpart);\n        remoteDtlsParameters.role = 'client';\n      }\n      recvEncodingParameters =\n          SDPUtils.parseRtpEncodingParameters(mediaSection);\n\n      var rtcpParameters = SDPUtils.parseRtcpParameters(mediaSection);\n\n      var isComplete = SDPUtils.matchPrefix(mediaSection,\n          'a=end-of-candidates', sessionpart).length > 0;\n      var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:')\n          .map(function(cand) {\n            return SDPUtils.parseCandidate(cand);\n          })\n          .filter(function(cand) {\n            return cand.component === 1;\n          });\n\n      // Check if we can use BUNDLE and dispose transports.\n      if ((description.type === 'offer' || description.type === 'answer') &&\n          !rejected && usingBundle && sdpMLineIndex > 0 &&\n          pc.transceivers[sdpMLineIndex]) {\n        pc._disposeIceAndDtlsTransports(sdpMLineIndex);\n        pc.transceivers[sdpMLineIndex].iceGatherer =\n            pc.transceivers[0].iceGatherer;\n        pc.transceivers[sdpMLineIndex].iceTransport =\n            pc.transceivers[0].iceTransport;\n        pc.transceivers[sdpMLineIndex].dtlsTransport =\n            pc.transceivers[0].dtlsTransport;\n        if (pc.transceivers[sdpMLineIndex].rtpSender) {\n          pc.transceivers[sdpMLineIndex].rtpSender.setTransport(\n              pc.transceivers[0].dtlsTransport);\n        }\n        if (pc.transceivers[sdpMLineIndex].rtpReceiver) {\n          pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(\n              pc.transceivers[0].dtlsTransport);\n        }\n      }\n      if (description.type === 'offer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex] ||\n            pc._createTransceiver(kind);\n        transceiver.mid = mid;\n\n        if (!transceiver.iceGatherer) {\n          transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex,\n              usingBundle);\n        }\n\n        if (cands.length && transceiver.iceTransport.state === 'new') {\n          if (isComplete && (!usingBundle || sdpMLineIndex === 0)) {\n            transceiver.iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function(candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        localCapabilities = window.RTCRtpReceiver.getCapabilities(kind);\n\n        // filter RTX until additional stuff needed for RTX is implemented\n        // in adapter.js\n        if (edgeVersion < 15019) {\n          localCapabilities.codecs = localCapabilities.codecs.filter(\n              function(codec) {\n                return codec.name !== 'rtx';\n              });\n        }\n\n        sendEncodingParameters = transceiver.sendEncodingParameters || [{\n          ssrc: (2 * sdpMLineIndex + 2) * 1001\n        }];\n\n        // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n        var isNewTrack = false;\n        if (direction === 'sendrecv' || direction === 'sendonly') {\n          isNewTrack = !transceiver.rtpReceiver;\n          rtpReceiver = transceiver.rtpReceiver ||\n              new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);\n\n          if (isNewTrack) {\n            var stream;\n            track = rtpReceiver.track;\n            // FIXME: does not work with Plan B.\n            if (remoteMsid && remoteMsid.stream === '-') {\n              // no-op. a stream id of '-' means: no associated stream.\n            } else if (remoteMsid) {\n              if (!streams[remoteMsid.stream]) {\n                streams[remoteMsid.stream] = new window.MediaStream();\n                Object.defineProperty(streams[remoteMsid.stream], 'id', {\n                  get: function() {\n                    return remoteMsid.stream;\n                  }\n                });\n              }\n              Object.defineProperty(track, 'id', {\n                get: function() {\n                  return remoteMsid.track;\n                }\n              });\n              stream = streams[remoteMsid.stream];\n            } else {\n              if (!streams.default) {\n                streams.default = new window.MediaStream();\n              }\n              stream = streams.default;\n            }\n            if (stream) {\n              addTrackToStreamAndFireEvent(track, stream);\n              transceiver.associatedRemoteMediaStreams.push(stream);\n            }\n            receiverList.push([track, rtpReceiver, stream]);\n          }\n        } else if (transceiver.rtpReceiver && transceiver.rtpReceiver.track) {\n          transceiver.associatedRemoteMediaStreams.forEach(function(s) {\n            var nativeTrack = s.getTracks().find(function(t) {\n              return t.id === transceiver.rtpReceiver.track.id;\n            });\n            if (nativeTrack) {\n              removeTrackFromStreamAndFireEvent(nativeTrack, s);\n            }\n          });\n          transceiver.associatedRemoteMediaStreams = [];\n        }\n\n        transceiver.localCapabilities = localCapabilities;\n        transceiver.remoteCapabilities = remoteCapabilities;\n        transceiver.rtpReceiver = rtpReceiver;\n        transceiver.rtcpParameters = rtcpParameters;\n        transceiver.sendEncodingParameters = sendEncodingParameters;\n        transceiver.recvEncodingParameters = recvEncodingParameters;\n\n        // Start the RTCRtpReceiver now. The RTPSender is started in\n        // setLocalDescription.\n        pc._transceive(pc.transceivers[sdpMLineIndex],\n            false,\n            isNewTrack);\n      } else if (description.type === 'answer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex];\n        iceGatherer = transceiver.iceGatherer;\n        iceTransport = transceiver.iceTransport;\n        dtlsTransport = transceiver.dtlsTransport;\n        rtpReceiver = transceiver.rtpReceiver;\n        sendEncodingParameters = transceiver.sendEncodingParameters;\n        localCapabilities = transceiver.localCapabilities;\n\n        pc.transceivers[sdpMLineIndex].recvEncodingParameters =\n            recvEncodingParameters;\n        pc.transceivers[sdpMLineIndex].remoteCapabilities =\n            remoteCapabilities;\n        pc.transceivers[sdpMLineIndex].rtcpParameters = rtcpParameters;\n\n        if (cands.length && iceTransport.state === 'new') {\n          if ((isIceLite || isComplete) &&\n              (!usingBundle || sdpMLineIndex === 0)) {\n            iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function(candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        if (!usingBundle || sdpMLineIndex === 0) {\n          if (iceTransport.state === 'new') {\n            iceTransport.start(iceGatherer, remoteIceParameters,\n                'controlling');\n          }\n          if (dtlsTransport.state === 'new') {\n            dtlsTransport.start(remoteDtlsParameters);\n          }\n        }\n\n        // If the offer contained RTX but the answer did not,\n        // remove RTX from sendEncodingParameters.\n        var commonCapabilities = getCommonCapabilities(\n          transceiver.localCapabilities,\n          transceiver.remoteCapabilities);\n\n        var hasRtx = commonCapabilities.codecs.filter(function(c) {\n          return c.name.toLowerCase() === 'rtx';\n        }).length;\n        if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {\n          delete transceiver.sendEncodingParameters[0].rtx;\n        }\n\n        pc._transceive(transceiver,\n            direction === 'sendrecv' || direction === 'recvonly',\n            direction === 'sendrecv' || direction === 'sendonly');\n\n        // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n        if (rtpReceiver &&\n            (direction === 'sendrecv' || direction === 'sendonly')) {\n          track = rtpReceiver.track;\n          if (remoteMsid) {\n            if (!streams[remoteMsid.stream]) {\n              streams[remoteMsid.stream] = new window.MediaStream();\n            }\n            addTrackToStreamAndFireEvent(track, streams[remoteMsid.stream]);\n            receiverList.push([track, rtpReceiver, streams[remoteMsid.stream]]);\n          } else {\n            if (!streams.default) {\n              streams.default = new window.MediaStream();\n            }\n            addTrackToStreamAndFireEvent(track, streams.default);\n            receiverList.push([track, rtpReceiver, streams.default]);\n          }\n        } else {\n          // FIXME: actually the receiver should be created later.\n          delete transceiver.rtpReceiver;\n        }\n      }\n    });\n\n    if (pc._dtlsRole === undefined) {\n      pc._dtlsRole = description.type === 'offer' ? 'active' : 'passive';\n    }\n\n    pc._remoteDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-remote-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n    Object.keys(streams).forEach(function(sid) {\n      var stream = streams[sid];\n      if (stream.getTracks().length) {\n        if (pc.remoteStreams.indexOf(stream) === -1) {\n          pc.remoteStreams.push(stream);\n          var event = new Event('addstream');\n          event.stream = stream;\n          window.setTimeout(function() {\n            pc._dispatchEvent('addstream', event);\n          });\n        }\n\n        receiverList.forEach(function(item) {\n          var track = item[0];\n          var receiver = item[1];\n          if (stream.id !== item[2].id) {\n            return;\n          }\n          fireAddTrack(pc, track, receiver, [stream]);\n        });\n      }\n    });\n    receiverList.forEach(function(item) {\n      if (item[2]) {\n        return;\n      }\n      fireAddTrack(pc, item[0], item[1], []);\n    });\n\n    // check whether addIceCandidate({}) was called within four seconds after\n    // setRemoteDescription.\n    window.setTimeout(function() {\n      if (!(pc && pc.transceivers)) {\n        return;\n      }\n      pc.transceivers.forEach(function(transceiver) {\n        if (transceiver.iceTransport &&\n            transceiver.iceTransport.state === 'new' &&\n            transceiver.iceTransport.getRemoteCandidates().length > 0) {\n          console.warn('Timeout for addRemoteCandidate. Consider sending ' +\n              'an end-of-candidates notification');\n          transceiver.iceTransport.addRemoteCandidate({});\n        }\n      });\n    }, 4000);\n\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.close = function() {\n    this.transceivers.forEach(function(transceiver) {\n      /* not yet\n      if (transceiver.iceGatherer) {\n        transceiver.iceGatherer.close();\n      }\n      */\n      if (transceiver.iceTransport) {\n        transceiver.iceTransport.stop();\n      }\n      if (transceiver.dtlsTransport) {\n        transceiver.dtlsTransport.stop();\n      }\n      if (transceiver.rtpSender) {\n        transceiver.rtpSender.stop();\n      }\n      if (transceiver.rtpReceiver) {\n        transceiver.rtpReceiver.stop();\n      }\n    });\n    // FIXME: clean up tracks, local streams, remote streams, etc\n    this._isClosed = true;\n    this._updateSignalingState('closed');\n  };\n\n  // Update the signaling state.\n  RTCPeerConnection.prototype._updateSignalingState = function(newState) {\n    this.signalingState = newState;\n    var event = new Event('signalingstatechange');\n    this._dispatchEvent('signalingstatechange', event);\n  };\n\n  // Determine whether to fire the negotiationneeded event.\n  RTCPeerConnection.prototype._maybeFireNegotiationNeeded = function() {\n    var pc = this;\n    if (this.signalingState !== 'stable' || this.needNegotiation === true) {\n      return;\n    }\n    this.needNegotiation = true;\n    window.setTimeout(function() {\n      if (pc.needNegotiation) {\n        pc.needNegotiation = false;\n        var event = new Event('negotiationneeded');\n        pc._dispatchEvent('negotiationneeded', event);\n      }\n    }, 0);\n  };\n\n  // Update the ice connection state.\n  RTCPeerConnection.prototype._updateIceConnectionState = function() {\n    var newState;\n    var states = {\n      'new': 0,\n      closed: 0,\n      checking: 0,\n      connected: 0,\n      completed: 0,\n      disconnected: 0,\n      failed: 0\n    };\n    this.transceivers.forEach(function(transceiver) {\n      if (transceiver.iceTransport && !transceiver.rejected) {\n        states[transceiver.iceTransport.state]++;\n      }\n    });\n\n    newState = 'new';\n    if (states.failed > 0) {\n      newState = 'failed';\n    } else if (states.checking > 0) {\n      newState = 'checking';\n    } else if (states.disconnected > 0) {\n      newState = 'disconnected';\n    } else if (states.new > 0) {\n      newState = 'new';\n    } else if (states.connected > 0) {\n      newState = 'connected';\n    } else if (states.completed > 0) {\n      newState = 'completed';\n    }\n\n    if (newState !== this.iceConnectionState) {\n      this.iceConnectionState = newState;\n      var event = new Event('iceconnectionstatechange');\n      this._dispatchEvent('iceconnectionstatechange', event);\n    }\n  };\n\n  // Update the connection state.\n  RTCPeerConnection.prototype._updateConnectionState = function() {\n    var newState;\n    var states = {\n      'new': 0,\n      closed: 0,\n      connecting: 0,\n      connected: 0,\n      completed: 0,\n      disconnected: 0,\n      failed: 0\n    };\n    this.transceivers.forEach(function(transceiver) {\n      if (transceiver.iceTransport && transceiver.dtlsTransport &&\n          !transceiver.rejected) {\n        states[transceiver.iceTransport.state]++;\n        states[transceiver.dtlsTransport.state]++;\n      }\n    });\n    // ICETransport.completed and connected are the same for this purpose.\n    states.connected += states.completed;\n\n    newState = 'new';\n    if (states.failed > 0) {\n      newState = 'failed';\n    } else if (states.connecting > 0) {\n      newState = 'connecting';\n    } else if (states.disconnected > 0) {\n      newState = 'disconnected';\n    } else if (states.new > 0) {\n      newState = 'new';\n    } else if (states.connected > 0) {\n      newState = 'connected';\n    }\n\n    if (newState !== this.connectionState) {\n      this.connectionState = newState;\n      var event = new Event('connectionstatechange');\n      this._dispatchEvent('connectionstatechange', event);\n    }\n  };\n\n  RTCPeerConnection.prototype.createOffer = function() {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not call createOffer after close'));\n    }\n\n    var numAudioTracks = pc.transceivers.filter(function(t) {\n      return t.kind === 'audio';\n    }).length;\n    var numVideoTracks = pc.transceivers.filter(function(t) {\n      return t.kind === 'video';\n    }).length;\n\n    // Determine number of audio and video tracks we need to send/recv.\n    var offerOptions = arguments[0];\n    if (offerOptions) {\n      // Reject Chrome legacy constraints.\n      if (offerOptions.mandatory || offerOptions.optional) {\n        throw new TypeError(\n            'Legacy mandatory/optional constraints not supported.');\n      }\n      if (offerOptions.offerToReceiveAudio !== undefined) {\n        if (offerOptions.offerToReceiveAudio === true) {\n          numAudioTracks = 1;\n        } else if (offerOptions.offerToReceiveAudio === false) {\n          numAudioTracks = 0;\n        } else {\n          numAudioTracks = offerOptions.offerToReceiveAudio;\n        }\n      }\n      if (offerOptions.offerToReceiveVideo !== undefined) {\n        if (offerOptions.offerToReceiveVideo === true) {\n          numVideoTracks = 1;\n        } else if (offerOptions.offerToReceiveVideo === false) {\n          numVideoTracks = 0;\n        } else {\n          numVideoTracks = offerOptions.offerToReceiveVideo;\n        }\n      }\n    }\n\n    pc.transceivers.forEach(function(transceiver) {\n      if (transceiver.kind === 'audio') {\n        numAudioTracks--;\n        if (numAudioTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      } else if (transceiver.kind === 'video') {\n        numVideoTracks--;\n        if (numVideoTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      }\n    });\n\n    // Create M-lines for recvonly streams.\n    while (numAudioTracks > 0 || numVideoTracks > 0) {\n      if (numAudioTracks > 0) {\n        pc._createTransceiver('audio');\n        numAudioTracks--;\n      }\n      if (numVideoTracks > 0) {\n        pc._createTransceiver('video');\n        numVideoTracks--;\n      }\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,\n        pc._sdpSessionVersion++);\n    pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n      // For each track, create an ice gatherer, ice transport,\n      // dtls transport, potentially rtpsender and rtpreceiver.\n      var track = transceiver.track;\n      var kind = transceiver.kind;\n      var mid = transceiver.mid || SDPUtils.generateIdentifier();\n      transceiver.mid = mid;\n\n      if (!transceiver.iceGatherer) {\n        transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex,\n            pc.usingBundle);\n      }\n\n      var localCapabilities = window.RTCRtpSender.getCapabilities(kind);\n      // filter RTX until additional stuff needed for RTX is implemented\n      // in adapter.js\n      if (edgeVersion < 15019) {\n        localCapabilities.codecs = localCapabilities.codecs.filter(\n            function(codec) {\n              return codec.name !== 'rtx';\n            });\n      }\n      localCapabilities.codecs.forEach(function(codec) {\n        // work around https://bugs.chromium.org/p/webrtc/issues/detail?id=6552\n        // by adding level-asymmetry-allowed=1\n        if (codec.name === 'H264' &&\n            codec.parameters['level-asymmetry-allowed'] === undefined) {\n          codec.parameters['level-asymmetry-allowed'] = '1';\n        }\n\n        // for subsequent offers, we might have to re-use the payload\n        // type of the last offer.\n        if (transceiver.remoteCapabilities &&\n            transceiver.remoteCapabilities.codecs) {\n          transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec) {\n            if (codec.name.toLowerCase() === remoteCodec.name.toLowerCase() &&\n                codec.clockRate === remoteCodec.clockRate) {\n              codec.preferredPayloadType = remoteCodec.payloadType;\n            }\n          });\n        }\n      });\n      localCapabilities.headerExtensions.forEach(function(hdrExt) {\n        var remoteExtensions = transceiver.remoteCapabilities &&\n            transceiver.remoteCapabilities.headerExtensions || [];\n        remoteExtensions.forEach(function(rHdrExt) {\n          if (hdrExt.uri === rHdrExt.uri) {\n            hdrExt.id = rHdrExt.id;\n          }\n        });\n      });\n\n      // generate an ssrc now, to be used later in rtpSender.send\n      var sendEncodingParameters = transceiver.sendEncodingParameters || [{\n        ssrc: (2 * sdpMLineIndex + 1) * 1001\n      }];\n      if (track) {\n        // add RTX\n        if (edgeVersion >= 15019 && kind === 'video' &&\n            !sendEncodingParameters[0].rtx) {\n          sendEncodingParameters[0].rtx = {\n            ssrc: sendEncodingParameters[0].ssrc + 1\n          };\n        }\n      }\n\n      if (transceiver.wantReceive) {\n        transceiver.rtpReceiver = new window.RTCRtpReceiver(\n            transceiver.dtlsTransport, kind);\n      }\n\n      transceiver.localCapabilities = localCapabilities;\n      transceiver.sendEncodingParameters = sendEncodingParameters;\n    });\n\n    // always offer BUNDLE and dispose on return if not supported.\n    if (pc._config.bundlePolicy !== 'max-compat') {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function(t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n    sdp += 'a=ice-options:trickle\\r\\n';\n\n    pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n      sdp += writeMediaSection(transceiver, transceiver.localCapabilities,\n          'offer', transceiver.stream, pc._dtlsRole);\n      sdp += 'a=rtcp-rsize\\r\\n';\n\n      if (transceiver.iceGatherer && pc.iceGatheringState !== 'new' &&\n          (sdpMLineIndex === 0 || !pc.usingBundle)) {\n        transceiver.iceGatherer.getLocalCandidates().forEach(function(cand) {\n          cand.component = 1;\n          sdp += 'a=' + SDPUtils.writeCandidate(cand) + '\\r\\n';\n        });\n\n        if (transceiver.iceGatherer.state === 'completed') {\n          sdp += 'a=end-of-candidates\\r\\n';\n        }\n      }\n    });\n\n    var desc = new window.RTCSessionDescription({\n      type: 'offer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.createAnswer = function() {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not call createAnswer after close'));\n    }\n\n    if (!(pc.signalingState === 'have-remote-offer' ||\n        pc.signalingState === 'have-local-pranswer')) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not call createAnswer in signalingState ' + pc.signalingState));\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,\n        pc._sdpSessionVersion++);\n    if (pc.usingBundle) {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function(t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n    sdp += 'a=ice-options:trickle\\r\\n';\n\n    var mediaSectionsInOffer = SDPUtils.getMediaSections(\n        pc._remoteDescription.sdp).length;\n    pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n      if (sdpMLineIndex + 1 > mediaSectionsInOffer) {\n        return;\n      }\n      if (transceiver.rejected) {\n        if (transceiver.kind === 'application') {\n          if (transceiver.protocol === 'DTLS/SCTP') { // legacy fmt\n            sdp += 'm=application 0 DTLS/SCTP 5000\\r\\n';\n          } else {\n            sdp += 'm=application 0 ' + transceiver.protocol +\n                ' webrtc-datachannel\\r\\n';\n          }\n        } else if (transceiver.kind === 'audio') {\n          sdp += 'm=audio 0 UDP/TLS/RTP/SAVPF 0\\r\\n' +\n              'a=rtpmap:0 PCMU/8000\\r\\n';\n        } else if (transceiver.kind === 'video') {\n          sdp += 'm=video 0 UDP/TLS/RTP/SAVPF 120\\r\\n' +\n              'a=rtpmap:120 VP8/90000\\r\\n';\n        }\n        sdp += 'c=IN IP4 0.0.0.0\\r\\n' +\n            'a=inactive\\r\\n' +\n            'a=mid:' + transceiver.mid + '\\r\\n';\n        return;\n      }\n\n      // FIXME: look at direction.\n      if (transceiver.stream) {\n        var localTrack;\n        if (transceiver.kind === 'audio') {\n          localTrack = transceiver.stream.getAudioTracks()[0];\n        } else if (transceiver.kind === 'video') {\n          localTrack = transceiver.stream.getVideoTracks()[0];\n        }\n        if (localTrack) {\n          // add RTX\n          if (edgeVersion >= 15019 && transceiver.kind === 'video' &&\n              !transceiver.sendEncodingParameters[0].rtx) {\n            transceiver.sendEncodingParameters[0].rtx = {\n              ssrc: transceiver.sendEncodingParameters[0].ssrc + 1\n            };\n          }\n        }\n      }\n\n      // Calculate intersection of capabilities.\n      var commonCapabilities = getCommonCapabilities(\n          transceiver.localCapabilities,\n          transceiver.remoteCapabilities);\n\n      var hasRtx = commonCapabilities.codecs.filter(function(c) {\n        return c.name.toLowerCase() === 'rtx';\n      }).length;\n      if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {\n        delete transceiver.sendEncodingParameters[0].rtx;\n      }\n\n      sdp += writeMediaSection(transceiver, commonCapabilities,\n          'answer', transceiver.stream, pc._dtlsRole);\n      if (transceiver.rtcpParameters &&\n          transceiver.rtcpParameters.reducedSize) {\n        sdp += 'a=rtcp-rsize\\r\\n';\n      }\n    });\n\n    var desc = new window.RTCSessionDescription({\n      type: 'answer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.addIceCandidate = function(candidate) {\n    var pc = this;\n    var sections;\n    if (candidate && !(candidate.sdpMLineIndex !== undefined ||\n        candidate.sdpMid)) {\n      return Promise.reject(new TypeError('sdpMLineIndex or sdpMid required'));\n    }\n\n    // TODO: needs to go into ops queue.\n    return new Promise(function(resolve, reject) {\n      if (!pc._remoteDescription) {\n        return reject(makeError('InvalidStateError',\n            'Can not add ICE candidate without a remote description'));\n      } else if (!candidate || candidate.candidate === '') {\n        for (var j = 0; j < pc.transceivers.length; j++) {\n          if (pc.transceivers[j].rejected) {\n            continue;\n          }\n          pc.transceivers[j].iceTransport.addRemoteCandidate({});\n          sections = SDPUtils.getMediaSections(pc._remoteDescription.sdp);\n          sections[j] += 'a=end-of-candidates\\r\\n';\n          pc._remoteDescription.sdp =\n              SDPUtils.getDescription(pc._remoteDescription.sdp) +\n              sections.join('');\n          if (pc.usingBundle) {\n            break;\n          }\n        }\n      } else {\n        var sdpMLineIndex = candidate.sdpMLineIndex;\n        if (candidate.sdpMid) {\n          for (var i = 0; i < pc.transceivers.length; i++) {\n            if (pc.transceivers[i].mid === candidate.sdpMid) {\n              sdpMLineIndex = i;\n              break;\n            }\n          }\n        }\n        var transceiver = pc.transceivers[sdpMLineIndex];\n        if (transceiver) {\n          if (transceiver.rejected) {\n            return resolve();\n          }\n          var cand = Object.keys(candidate.candidate).length > 0 ?\n              SDPUtils.parseCandidate(candidate.candidate) : {};\n          // Ignore Chrome's invalid candidates since Edge does not like them.\n          if (cand.protocol === 'tcp' && (cand.port === 0 || cand.port === 9)) {\n            return resolve();\n          }\n          // Ignore RTCP candidates, we assume RTCP-MUX.\n          if (cand.component && cand.component !== 1) {\n            return resolve();\n          }\n          // when using bundle, avoid adding candidates to the wrong\n          // ice transport. And avoid adding candidates added in the SDP.\n          if (sdpMLineIndex === 0 || (sdpMLineIndex > 0 &&\n              transceiver.iceTransport !== pc.transceivers[0].iceTransport)) {\n            if (!maybeAddCandidate(transceiver.iceTransport, cand)) {\n              return reject(makeError('OperationError',\n                  'Can not add ICE candidate'));\n            }\n          }\n\n          // update the remoteDescription.\n          var candidateString = candidate.candidate.trim();\n          if (candidateString.indexOf('a=') === 0) {\n            candidateString = candidateString.substr(2);\n          }\n          sections = SDPUtils.getMediaSections(pc._remoteDescription.sdp);\n          sections[sdpMLineIndex] += 'a=' +\n              (cand.type ? candidateString : 'end-of-candidates')\n              + '\\r\\n';\n          pc._remoteDescription.sdp =\n              SDPUtils.getDescription(pc._remoteDescription.sdp) +\n              sections.join('');\n        } else {\n          return reject(makeError('OperationError',\n              'Can not add ICE candidate'));\n        }\n      }\n      resolve();\n    });\n  };\n\n  RTCPeerConnection.prototype.getStats = function(selector) {\n    if (selector && selector instanceof window.MediaStreamTrack) {\n      var senderOrReceiver = null;\n      this.transceivers.forEach(function(transceiver) {\n        if (transceiver.rtpSender &&\n            transceiver.rtpSender.track === selector) {\n          senderOrReceiver = transceiver.rtpSender;\n        } else if (transceiver.rtpReceiver &&\n            transceiver.rtpReceiver.track === selector) {\n          senderOrReceiver = transceiver.rtpReceiver;\n        }\n      });\n      if (!senderOrReceiver) {\n        throw makeError('InvalidAccessError', 'Invalid selector.');\n      }\n      return senderOrReceiver.getStats();\n    }\n\n    var promises = [];\n    this.transceivers.forEach(function(transceiver) {\n      ['rtpSender', 'rtpReceiver', 'iceGatherer', 'iceTransport',\n          'dtlsTransport'].forEach(function(method) {\n            if (transceiver[method]) {\n              promises.push(transceiver[method].getStats());\n            }\n          });\n    });\n    return Promise.all(promises).then(function(allStats) {\n      var results = new Map();\n      allStats.forEach(function(stats) {\n        stats.forEach(function(stat) {\n          results.set(stat.id, stat);\n        });\n      });\n      return results;\n    });\n  };\n\n  // fix low-level stat names and return Map instead of object.\n  var ortcObjects = ['RTCRtpSender', 'RTCRtpReceiver', 'RTCIceGatherer',\n    'RTCIceTransport', 'RTCDtlsTransport'];\n  ortcObjects.forEach(function(ortcObjectName) {\n    var obj = window[ortcObjectName];\n    if (obj && obj.prototype && obj.prototype.getStats) {\n      var nativeGetstats = obj.prototype.getStats;\n      obj.prototype.getStats = function() {\n        return nativeGetstats.apply(this)\n        .then(function(nativeStats) {\n          var mapStats = new Map();\n          Object.keys(nativeStats).forEach(function(id) {\n            nativeStats[id].type = fixStatsType(nativeStats[id]);\n            mapStats.set(id, nativeStats[id]);\n          });\n          return mapStats;\n        });\n      };\n    }\n  });\n\n  // legacy callback shims. Should be moved to adapter.js some days.\n  var methods = ['createOffer', 'createAnswer'];\n  methods.forEach(function(method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n    RTCPeerConnection.prototype[method] = function() {\n      var args = arguments;\n      if (typeof args[0] === 'function' ||\n          typeof args[1] === 'function') { // legacy\n        return nativeMethod.apply(this, [arguments[2]])\n        .then(function(description) {\n          if (typeof args[0] === 'function') {\n            args[0].apply(null, [description]);\n          }\n        }, function(error) {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null, [error]);\n          }\n        });\n      }\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n\n  methods = ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'];\n  methods.forEach(function(method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n    RTCPeerConnection.prototype[method] = function() {\n      var args = arguments;\n      if (typeof args[1] === 'function' ||\n          typeof args[2] === 'function') { // legacy\n        return nativeMethod.apply(this, arguments)\n        .then(function() {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        }, function(error) {\n          if (typeof args[2] === 'function') {\n            args[2].apply(null, [error]);\n          }\n        });\n      }\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n\n  // getStats is special. It doesn't have a spec legacy method yet we support\n  // getStats(something, cb) without error callbacks.\n  ['getStats'].forEach(function(method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n    RTCPeerConnection.prototype[method] = function() {\n      var args = arguments;\n      if (typeof args[1] === 'function') {\n        return nativeMethod.apply(this, arguments)\n        .then(function() {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        });\n      }\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n\n  return RTCPeerConnection;\n};\n"]},"metadata":{},"sourceType":"script"}